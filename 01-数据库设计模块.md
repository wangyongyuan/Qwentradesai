# 数据库设计模块

## 一、数据库选型

- **数据库**：PostgreSQL + TimescaleDB（时序数据库扩展）
- **连接池**：SQLAlchemy
- **ORM**：SQLAlchemy ORM

## 二、核心数据表

### 2.1 K线数据表

#### klines_15m（15分钟K线）
- 主键：`(symbol, time)`
- 基础数据：open, high, low, close, volume
- 技术指标：RSI(7), MACD, EMA(9,21,55), 布林带, ATR(14), OBV, ADX(14)

#### klines_4h（4小时K线）
- 主键：`(symbol, time)`
- 基础数据：open, high, low, close, volume
- 技术指标：RSI(14), MACD, EMA(9,21), 布林带, OBV

#### klines_1d（日线）
- 主键：`(symbol, time)`
- 基础数据：open, high, low, close, volume
- 技术指标：EMA(9,21)

### 2.2 市场数据表

#### funding_rate_history（资金费率历史）
- 主键：`(symbol, time)`
- 字段：funding_rate, open_interest
- 更新频率：每8小时

#### open_interest_15m（未平仓合约15分钟）
- 主键：`(symbol, time)`
- 字段：oi_open, oi_high, oi_low, oi_close, oi_change, oi_change_pct

#### market_sentiment_data（市场情绪数据）
- 主键：`(symbol, time)`
- 字段：global_account_long_percent, global_account_short_percent, long_short_ratio

#### order_book_distribution（盘口挂单分布）
- 主键：`(symbol, time)`
- 字段：asks, bids, total_ask_amount, total_bid_amount, bid_ask_ratio

#### etf_flow_data（ETF资金流）
- 主键：`(symbol, date)`
- 字段：net_assets_usd, change_usd, price_usd

#### fear_greed_index（恐惧贪婪指数）
- 主键：`date`
- 字段：value, classification, change

### 2.3 系统配置表

#### system_config（系统配置）
- 主键：`config_key`
- 字段：config_value, config_type, category, description
- 用途：存储所有系统配置项

#### system_status（系统状态）
- 主键：`key`
- 字段：value, updated_at
- 用途：存储系统运行状态

## 三、数据表关系

```
klines_15m/4h/1d (独立表，无外键)
funding_rate_history (独立表)
open_interest_15m (独立表)
market_sentiment_data (独立表)
order_book_distribution (独立表)
etf_flow_data (独立表)
fear_greed_index (独立表)
system_config (独立表)
system_status (独立表)
```

## 四、索引设计

### 4.1 主键索引
- 所有表使用复合主键 `(symbol, time)` 或单主键
- 自动创建唯一索引

### 4.2 查询索引
```sql
-- K线表按时间查询
CREATE INDEX idx_klines_15m_time ON klines_15m(time);
CREATE INDEX idx_klines_4h_time ON klines_4h(time);
CREATE INDEX idx_klines_1d_time ON klines_1d(time);

-- 配置表按分类查询
CREATE INDEX idx_system_config_category ON system_config(category);
```

## 五、数据存储

### 5.1 数据类型
- **价格/数量**：`DECIMAL(20, 8)` - 支持高精度
- **百分比**：`DECIMAL(10, 4)` - 支持小数点后4位
- **时间**：`TIMESTAMPTZ` - 带时区的时间戳
- **JSON数据**：`JSONB` - 二进制JSON，支持索引

### 5.2 时区处理
- 所有时间字段使用UTC时区
- 存储时自动转换为UTC
- 查询时返回UTC时间

## 六、数据访问

### 6.1 Repository模式
```python
from app.database.klines import KlineRepository

# 获取K线数据（含指标）
klines = KlineRepository.get_klines_with_indicators(
    session, '15m', 'ETH', limit=100
)
```

### 6.2 常用查询
```python
# 获取最新K线
latest = KlineRepository.get_latest_kline(session, '15m', 'ETH')

# 获取时间范围内的K线
klines = KlineRepository.get_klines_by_time_range(
    session, '15m', 'ETH', start_time, end_time
)
```

## 七、配置管理

### 7.1 配置表结构
```sql
CREATE TABLE system_config (
    config_key VARCHAR(100) PRIMARY KEY,
    config_value TEXT,
    config_type VARCHAR(20),  -- string/int/float/bool/json
    category VARCHAR(50),     -- trading/api/database等
    description TEXT
);
```

### 7.2 配置访问
```python
from app.database.config_manager import ConfigManager

config = ConfigManager(db)
value = config.get('SYMBOL', 'ETH')
int_value = config.get_int('MAX_LEVERAGE', 3)
```

## 八、注意事项

1. **数据完整性**：使用主键约束防止重复数据
2. **时区统一**：所有时间使用UTC时区
3. **精度保证**：价格使用DECIMAL保证精度
4. **索引优化**：常用查询字段建立索引
5. **配置管理**：所有配置存储在数据库，支持动态更新

