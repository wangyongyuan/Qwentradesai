# 基础设施架构文档

## 一、概述

### 1.1 基础设施模块职责

基础设施层为整个系统提供基础服务，包括：

- **API请求管理**：统一管理交易所API请求，实现限流、重试、优先级调度
- **外部数据源集成**：集成CoinGlass API获取市场情绪、未平仓合约等数据
- **配置管理**：从数据库读取配置，支持动态配置更新
- **技术指标计算**：提供统一的技术指标计算接口
- **日志系统**：统一的日志记录和管理

### 1.2 核心组件

| 组件 | 文件路径 | 职责 |
|------|---------|------|
| APIManager | `app/components/api_manager.py` | 交易所API请求管理、限流、重试 |
| CoinGlassClient | `app/components/coinglass_client.py` | CoinGlass API客户端 |
| ConfigManager | `app/database/config_manager.py` | 数据库配置管理 |
| IndicatorCalculator | `app/components/indicator_calculator.py` | 技术指标计算 |
| Logger | `app/utils/logger.py` | 日志系统 |

### 1.3 设计理念

- **统一管理**：所有API请求通过APIManager统一管理，避免直接调用
- **限流保护**：自动限流，防止API调用超限
- **优先级调度**：重要请求（如止损）优先执行
- **错误隔离**：错误不影响其他请求，自动重试
- **配置集中**：所有配置从数据库读取，便于管理

## 二、APIManager 设计

### 2.1 类结构

```python
class APIManager:
    def __init__(self):
        self.exchange: ccxt.Exchange  # CCXT交易所实例
        self.request_queue: PriorityQueue  # 优先级请求队列
        self.worker_thread: threading.Thread  # 工作线程
        self.rate_limit: int  # 速率限制
        self.rate_window: float  # 时间窗口
        self.request_count: int  # 请求计数
        self.window_start: float  # 窗口开始时间
        self.last_request_time: float  # 上次请求时间
```

### 2.2 初始化流程

1. **初始化交易所**：使用CCXT创建交易所实例（OKX）
2. **配置限流参数**：从配置读取限流设置
3. **创建请求队列**：使用PriorityQueue实现优先级队列
4. **启动工作线程**：创建单线程处理请求队列

### 2.3 依赖关系

- **依赖ConfigManager**：读取API配置（限流、超时等）
- **依赖Logger**：记录请求日志和错误
- **依赖CCXT**：交易所API封装

## 三、API请求管理

### 3.1 请求封装

#### 3.1.1 APIRequest数据结构

```python
@dataclass
class APIRequest:
    priority: RequestPriority  # 优先级
    func: Callable  # 要执行的函数
    args: tuple  # 函数参数
    kwargs: dict  # 函数关键字参数
    callback: Optional[Callable] = None  # 回调函数
    timestamp: float = 0  # 请求时间戳
```

#### 3.1.2 请求优先级

优先级定义（数值越小优先级越高）：

- **STOP_LOSS = 1**：止损请求（最高优先级）
- **TRADE = 2**：交易请求（下单、撤单）
- **QUERY = 3**：查询请求（最低优先级）

#### 3.1.3 请求回调

请求完成后通过回调返回结果，支持同步和异步两种方式。

### 3.2 请求提交

#### 3.2.1 submit_request方法

```python
def submit_request(
    self,
    priority: RequestPriority,
    func: Callable,
    *args,
    callback: Optional[Callable] = None,
    **kwargs
) -> Any:
```

**功能**：提交API请求（同步方式）

**流程**：
1. 创建APIRequest对象
2. 放入优先级队列
3. 等待结果（使用Event同步）
4. 返回结果或抛出异常

#### 3.2.2 请求入队

使用PriorityQueue，元组格式：`(priority.value, timestamp, request)`

- 优先级值越小越先执行
- 相同优先级按时间戳排序

#### 3.2.3 结果返回

使用`threading.Event`实现同步等待，超时时间由`API_REQUEST_TIMEOUT`配置。

### 3.3 请求队列

#### 3.3.1 PriorityQueue设计

使用Python标准库`queue.PriorityQueue`，线程安全。

#### 3.3.2 队列大小

无大小限制，但建议监控队列长度，避免积压。

#### 3.3.3 队列操作

- **put**：放入请求（阻塞）
- **get**：获取请求（阻塞，超时1秒）
- **task_done**：标记任务完成
- **join**：等待所有任务完成

## 四、优先级调度

### 4.1 优先级定义

#### 4.1.1 STOP_LOSS（优先级1）

止损相关请求，最高优先级，确保及时止损。

#### 4.1.2 TRADE（优先级2）

交易相关请求：下单、撤单、修改订单等。

#### 4.1.3 QUERY（优先级3）

查询相关请求：查询余额、订单状态、K线数据等。

### 4.2 优先级队列

#### 4.2.1 队列实现

使用`PriorityQueue`，元组比较规则：
1. 先比较优先级值（越小越优先）
2. 优先级相同则比较时间戳（越小越优先）

#### 4.2.2 优先级比较

```python
# 队列元素格式
(priority.value, timestamp, request)
# 例如：(1, 1234567890.123, request)
```

### 4.3 调度策略

单线程顺序执行，按优先级从队列取出请求，执行完成后处理下一个。

## 五、限流机制

### 5.1 速率限制

#### 5.1.1 时间窗口算法

使用滑动时间窗口算法：
- 时间窗口：`API_RATE_WINDOW`（默认2秒）
- 最大请求数：`API_RATE_LIMIT`（默认10次）
- 超过限制时等待窗口重置

#### 5.1.2 请求计数

```python
# 检查时间窗口
if current_time - window_start >= rate_window:
    request_count = 0
    window_start = current_time

# 检查是否超限
if request_count >= rate_limit:
    wait_time = rate_window - (current_time - window_start)
    time.sleep(wait_time)
```

#### 5.1.3 限流检查

在每次请求执行前检查，超限则等待。

### 5.2 最小间隔

#### 5.2.1 间隔控制

确保请求间隔不小于`API_MIN_INTERVAL`（默认0.2秒）。

#### 5.2.2 时间戳记录

记录`last_request_time`，计算与当前时间的间隔。

### 5.3 限流配置

#### 5.3.1 API_RATE_LIMIT

每时间窗口内允许的最大请求次数，默认10。

#### 5.3.2 API_RATE_WINDOW

时间窗口大小（秒），默认2.0。

#### 5.3.3 API_MIN_INTERVAL

最小请求间隔（秒），默认0.2。

## 六、重试机制

### 6.1 重试策略

**注意**：当前实现中，重试逻辑由调用方处理，APIManager不自动重试。

#### 6.1.1 最大重试次数

由配置`API_MAX_RETRIES`定义，默认3次。

#### 6.1.2 重试条件

网络错误、超时错误等可重试错误。

#### 6.1.3 不重试条件

认证错误、参数错误等不可重试错误。

### 6.2 重试实现

调用方在捕获异常后自行实现重试逻辑。

### 6.3 重试配置

#### 6.3.1 API_MAX_RETRIES

最大重试次数，默认3。

#### 6.3.2 API_REQUEST_TIMEOUT

请求超时时间（秒），默认30。

## 七、工作线程模型

### 7.1 单工作线程设计

使用单线程处理所有API请求，避免并发问题，简化限流实现。

### 7.2 线程启动

#### 7.2.1 线程创建

```python
self.worker_thread = threading.Thread(
    target=self._worker_thread,
    daemon=True
)
```

#### 7.2.2 线程运行

调用`start()`方法启动线程。

### 7.3 线程主循环

#### 7.3.1 队列获取

```python
_, _, request = self.request_queue.get(timeout=1)
```

阻塞获取请求，超时1秒后继续循环。

#### 7.3.2 限流检查

执行`_check_rate_limit()`和`_enforce_min_interval()`。

#### 7.3.3 请求执行

```python
result = request.func(*request.args, **request.kwargs)
```

#### 7.3.4 回调处理

```python
if request.callback:
    request.callback(result, None)  # 成功
    # 或
    request.callback(None, e)  # 失败
```

### 7.4 线程停止

#### 7.4.1 优雅关闭

设置`running = False`，等待队列处理完成。

#### 7.4.2 队列处理完成

使用`request_queue.join()`等待所有任务完成。

## 八、API封装

### 8.1 账户相关API

#### 8.1.1 get_balance

获取账户USDT余额。

**实现**：调用`exchange.fetch_balance({'type': 'swap'})`，返回USDT可用余额。

#### 8.1.2 实现细节

- 检查API密钥是否配置
- 处理认证错误（仅记录警告，不抛异常）
- 返回`None`表示获取失败

### 8.2 市场数据API

#### 8.2.1 get_klines

获取K线数据。

**参数**：
- `symbol`：交易对（CCXT格式）
- `timeframe`：时间周期（15m/4h/1d等）
- `limit`：返回数量
- `since`：起始时间戳

#### 8.2.2 实现细节

调用`exchange.fetch_ohlcv()`，自动处理markets加载。

### 8.3 交易相关API

#### 8.3.1 create_order

创建订单（下单）。

**参数**：
- `symbol`：交易对
- `type`：订单类型（market/limit/stop_market）
- `side`：买卖方向（buy/sell）
- `amount`：数量（币的数量）
- `price`：价格（限价单必需）
- `params`：额外参数（杠杆、止盈止损等）

**实现细节**：
- 自动处理合约乘数转换（ETH合约乘数0.1）
- 支持止盈止损参数
- CCXT失败时自动降级到OKX原始API

#### 8.3.2 cancel_order

取消订单（撤单）。

**参数**：
- `order_id`：订单ID
- `symbol`：交易对

#### 8.3.3 fetch_order

查询订单状态。

**返回**：订单信息（状态、成交价、成交数量等）

#### 8.3.4 实现细节

所有交易API都检查API密钥配置，认证错误记录警告。

### 8.4 持仓相关API

#### 8.4.1 get_positions

查询持仓信息（通过`get_account_balance`实现）。

#### 8.4.2 实现细节

使用OKX原始API `private_get_account_balance`，返回完整账户信息。

### 8.5 条件单API

#### 8.5.1 create_algo_order

创建策略委托订单（OCO订单）。

**参数**：
- `inst_id`：产品ID（如ETH-USDT-SWAP）
- `td_mode`：交易模式（cross/isolated）
- `pos_side`：持仓方向（long/short）
- `sz`：数量（合约张数）
- `take_profit_trigger`：止盈触发价
- `stop_loss_trigger`：止损触发价

#### 8.5.2 cancel_algo_order

取消策略委托订单。

**参数**：`algo_orders`：策略订单列表

#### 8.5.3 实现细节

使用OKX原始API `private_post_trade_order_algo`和`private_post_trade_cancel_algos`。

## 九、CCXT集成

### 9.1 交易所初始化

#### 9.1.1 交易所选择

固定使用OKX交易所（`ccxt.okx`）。

#### 9.1.2 配置参数

```python
exchange_config = {
    'apiKey': settings.EXCHANGE_API_KEY,
    'secret': settings.EXCHANGE_SECRET,
    'password': settings.EXCHANGE_PASSPHRASE,
    'sandbox': settings.EXCHANGE_SANDBOX,
    'enableRateLimit': False,  # 我们自己控制限流
    'options': {
        'defaultType': 'swap',  # 永续合约
    }
}
```

### 9.2 交易所配置

#### 9.2.1 API密钥配置

从配置读取API密钥、Secret、Passphrase。

#### 9.2.2 沙箱/生产环境

通过`EXCHANGE_SANDBOX`配置切换。

#### 9.2.3 默认类型（永续合约）

固定使用`swap`（永续合约）。

### 9.3 CCXT方法调用

#### 9.3.1 方法封装

所有CCXT方法调用都通过APIManager封装，统一限流和错误处理。

#### 9.3.2 参数转换

- 交易对格式：`ETH/USDT:USDT`（CCXT格式）
- 合约乘数：自动处理（ETH=0.1，BTC=1.0）

## 十、错误处理

### 10.1 错误分类

#### 10.1.1 网络错误

网络超时、连接失败等，可重试。

#### 10.1.2 API错误

API返回错误码、参数错误等，根据错误类型决定是否重试。

#### 10.1.3 认证错误

API密钥未配置或无效，不重试，仅记录警告。

### 10.2 错误处理策略

#### 10.2.1 认证错误处理

```python
if ('401' in error_str or 'Unauthorized' in error_str or
    'apiKey' in error_str):
    logger.warning(f"API请求认证失败: {error_str}")
```

不记录完整堆栈，避免日志过多。

#### 10.2.2 其他错误处理

记录完整错误信息和堆栈，便于调试。

### 10.3 错误日志

#### 10.3.1 日志级别

- **WARNING**：认证错误
- **ERROR**：其他错误

#### 10.3.2 日志内容

包含错误信息、请求参数、响应内容等。

## 十一、CoinGlassClient 设计

### 11.1 类结构

```python
class CoinGlassClient:
    def __init__(self, settings: Settings):
        self.base_url: str  # API基础URL
        self.api_key: Optional[str]  # API密钥
        self.headers: dict  # HTTP请求头
```

### 11.2 初始化流程

1. 从配置读取`COINGLASS_BASE_URL`和`COINGLASS_API_KEY`
2. 构建HTTP请求头（包含API密钥）
3. 初始化HTTP客户端

### 11.3 HTTP客户端

使用`requests`库发送HTTP GET请求，超时30秒。

## 十二、CoinGlass API封装

### 12.1 未平仓合约API

**方法**：`get_open_interest_history`

**参数**：
- `symbol`：币种名称（BTC、ETH等）
- `exchange`：交易所（默认OKX）
- `interval`：时间间隔（默认4h）
- `start_time`、`end_time`：时间范围

**返回**：未平仓合约历史数据列表

### 12.2 市场情绪API

**方法**：`get_long_short_ratio_history`

**参数**：
- `symbol`：币种名称
- `exchange`：交易所（默认Binance）
- `interval`：时间间隔
- `limit`：返回数量

**返回**：多空持仓人数比历史数据

### 12.3 ETF资金流API

**方法**：`get_etf_flow_history`

**参数**：`symbol`：币种名称（仅支持BTC、ETH）

**返回**：ETF净资产和资金流历史数据

### 12.4 恐惧贪婪指数API

**方法**：`get_fear_greed_history`

**参数**：`start_time`、`end_time`：时间范围（可选）

**返回**：恐惧贪婪指数数据（包含data_list、price_list、time_list）

### 12.5 爆仓历史API

**方法**：`get_liquidation_history`

**参数**：
- `symbol`：币种名称
- `exchange_list`：交易所列表（逗号分隔）
- `interval`：时间间隔
- `limit`：返回数量（最大1000）

**返回**：爆仓历史数据列表

## 十三、请求限流

### 13.1 限流策略

CoinGlass API没有明确的限流要求，但建议：
- 控制请求频率，避免过于频繁
- 使用合理的超时时间（30秒）

### 13.2 限流实现

当前实现中，CoinGlass请求不经过APIManager，由调用方控制频率。

### 13.3 错误重试

- **Upgrade plan错误**：记录警告，不重试
- **其他错误**：记录错误，由调用方决定是否重试

## 十四、ConfigManager 设计

### 14.1 类结构

```python
class ConfigManager:
    def __init__(self, db: Database):
        self.db: Database  # 数据库连接
        self._cache: Dict[str, Any]  # 配置缓存
```

### 14.2 初始化流程

1. 接收数据库连接实例
2. 初始化配置缓存
3. 从数据库加载所有配置到缓存

### 14.3 数据库连接

依赖`Database`类获取数据库会话，查询`system_config`表。

## 十五、配置读取

### 15.1 配置类型

#### 15.1.1 string类型

字符串配置，直接存储和读取。

#### 15.1.2 int类型

整数配置，读取时转换为int。

#### 15.1.3 float类型

浮点数配置，读取时转换为float。

#### 15.1.4 bool类型

布尔配置，支持多种格式：'true'、'1'、'yes'等。

### 15.2 配置获取

#### 15.2.1 get_string方法

获取字符串配置，默认值''。

#### 15.2.2 get_int方法

获取整数配置，默认值0，转换失败返回默认值。

#### 15.2.3 get_float方法

获取浮点数配置，默认值0.0，转换失败返回默认值。

#### 15.2.4 get_bool方法

获取布尔配置，默认值False。

### 15.3 默认值处理

配置不存在时返回默认值，不抛异常。

### 15.4 配置缓存

所有配置启动时加载到内存缓存，提高读取性能。

## 十六、配置项说明

### 16.1 应用配置

#### 16.1.1 APP_NAME

应用名称，默认'QwenTradeAI'。

#### 16.1.2 APP_VERSION

应用版本号，默认'2.0'。

#### 16.1.3 DEBUG

调试模式开关，默认False。

### 16.2 交易所配置

#### 16.2.1 EXCHANGE_API_KEY

OKX API密钥（可选）。

#### 16.2.2 EXCHANGE_SECRET

OKX API Secret（可选）。

#### 16.2.3 EXCHANGE_PASSPHRASE

OKX API Passphrase（可选）。

#### 16.2.4 EXCHANGE_SANDBOX

是否使用沙箱环境，默认True。

### 16.3 技术指标配置

#### 16.3.1 RSI配置

- `RSI_15M_PERIOD`：15分钟RSI周期，默认7
- `RSI_15M_OVERSOLD`：15分钟超卖阈值，默认20.0
- `RSI_15M_OVERBOUGHT`：15分钟超买阈值，默认80.0
- `RSI_4H_PERIOD`：4小时RSI周期，默认14
- `RSI_4H_OVERSOLD`：4小时超卖阈值，默认30.0
- `RSI_4H_OVERBOUGHT`：4小时超买阈值，默认70.0

#### 16.3.2 MACD配置

- `MACD_15M_FAST`：15分钟MACD快线，默认8
- `MACD_15M_SLOW`：15分钟MACD慢线，默认17
- `MACD_15M_SIGNAL`：15分钟MACD信号线，默认9
- `MACD_4H_FAST`：4小时MACD快线，默认12
- `MACD_4H_SLOW`：4小时MACD慢线，默认26
- `MACD_4H_SIGNAL`：4小时MACD信号线，默认9

#### 16.3.3 EMA配置

- `EMA_SHORT`：短期EMA周期，默认9
- `EMA_MID`：中期EMA周期，默认21
- `EMA_LONG`：长期EMA周期，默认55

#### 16.3.4 布林带配置

- `BB_PERIOD`：布林带周期，默认20
- `BB_STD`：布林带标准差倍数，默认2.0

### 16.4 同步配置

#### 16.4.1 K线同步配置

- `KLINE_15M_START_DAYS`：15分钟K线初始同步天数，默认30
- `KLINE_4H_START_DAYS`：4小时K线初始同步天数，默认180
- `KLINE_1D_START_DAYS`：日线K线初始同步天数，默认600

#### 16.4.2 其他同步配置

- `FUNDING_RATE_START_DAYS`：资金费率初始同步天数，默认30

### 16.5 API配置

#### 16.5.1 限流配置

- `API_RATE_LIMIT`：每时间窗口最大请求数，默认10
- `API_RATE_WINDOW`：时间窗口（秒），默认2.0
- `API_MIN_INTERVAL`：最小请求间隔（秒），默认0.2

#### 16.5.2 重试配置

- `API_MAX_RETRIES`：最大重试次数，默认3

#### 16.5.3 超时配置

- `API_REQUEST_TIMEOUT`：请求超时时间（秒），默认30

### 16.6 WebSocket配置

- `WS_RECONNECT_INTERVAL`：重连间隔（秒），默认5
- `WS_HEARTBEAT_INTERVAL`：心跳间隔（秒），默认20
- `WS_PING_TIMEOUT`：ping超时（秒），默认5
- `WS_CONNECT_TIMEOUT`：连接超时（秒），默认30
- `WS_SUBSCRIBE_TIMEOUT`：订阅超时（秒），默认30
- `WS_PRICE_TIMEOUT`：价格超时（秒），默认30
- `WS_QUEUE_MAXSIZE`：价格队列最大长度，默认100

### 16.7 市场检测器配置

详见市场检测架构文档。

## 十七、IndicatorCalculator 设计

### 17.1 类结构

```python
class IndicatorCalculator:
    def __init__(self):
        self.db: Database  # 数据库连接
```

### 17.2 计算接口

提供统一的技术指标计算接口，支持：
- 单指标计算（EMA、RSI、MACD等）
- 批量计算（一次性计算所有指标）
- 数据库更新（计算后自动更新到数据库）

## 十八、技术指标计算

### 18.1 EMA计算

#### 18.1.1 计算方法

使用pandas的`ewm`方法：

```python
df['close'].ewm(span=period, adjust=False).mean()
```

#### 18.1.2 参数说明

- `period`：EMA周期（9、21、55等）
- `adjust=False`：使用标准EMA公式

### 18.2 RSI计算

#### 18.2.1 计算方法

```python
delta = df['close'].diff()
gain = (delta.where(delta > 0, 0)).rolling(window=period).mean()
loss = (-delta.where(delta < 0, 0)).rolling(window=period).mean()
rs = gain / loss
rsi = 100 - (100 / (1 + rs))
```

#### 18.2.2 参数说明

- `period`：RSI周期（7、14等）

### 18.3 MACD计算

#### 18.3.1 计算方法

```python
ema_fast = df['close'].ewm(span=fast, adjust=False).mean()
ema_slow = df['close'].ewm(span=slow, adjust=False).mean()
macd_line = ema_fast - ema_slow
signal_line = macd_line.ewm(span=signal, adjust=False).mean()
histogram = macd_line - signal_line
```

#### 18.3.2 参数说明

- `fast`：快线周期（8、12）
- `slow`：慢线周期（17、26）
- `signal`：信号线周期（9）

### 18.4 布林带计算

#### 18.4.1 计算方法

```python
middle = df['close'].rolling(window=period).mean()
std = df['close'].rolling(window=period).std()
upper = middle + (std * std_dev)
lower = middle - (std * std_dev)
```

#### 18.4.2 参数说明

- `period`：布林带周期（默认20）
- `std_dev`：标准差倍数（默认2.0）

### 18.5 ATR计算

计算平均真实波幅：

```python
high_low = df['high'] - df['low']
high_close = np.abs(df['high'] - df['close'].shift())
low_close = np.abs(df['low'] - df['close'].shift())
ranges = pd.concat([high_low, high_close, low_close], axis=1)
true_range = ranges.max(axis=1)
atr = true_range.rolling(window=period).mean()
```

**参数**：`period`：ATR周期（默认14）

### 18.6 OBV计算

计算能量潮指标：

```python
obv = (np.sign(df['close'].diff()) * df['volume']).fillna(0).cumsum()
```

### 18.7 ADX计算

计算平均方向性指标：

```python
# 计算真实波幅
tr = pd.concat([high_low, high_close, low_close], axis=1).max(axis=1)

# 计算方向移动
plus_dm = df['high'].diff()
minus_dm = -df['low'].diff()
plus_dm[plus_dm < 0] = 0
minus_dm[minus_dm < 0] = 0

# 平滑处理（Wilder's平滑）
atr = tr.ewm(alpha=1.0/period, adjust=False).mean()
plus_di = 100 * (plus_dm.ewm(alpha=1.0/period, adjust=False).mean() / atr)
minus_di = 100 * (minus_dm.ewm(alpha=1.0/period, adjust=False).mean() / atr)

# 计算ADX
dx = 100 * np.abs(plus_di - minus_di) / (plus_di + minus_di)
adx = dx.ewm(alpha=1.0/period, adjust=False).mean()
```

**参数**：`period`：ADX周期（默认14）

### 18.8 批量计算优化

- **一次性计算**：对整个DataFrame一次性计算所有指标，避免重复计算
- **批量更新**：每100根K线提交一次数据库更新，提高性能
- **最小数据要求**：根据指标要求的最小数据量，跳过数据不足的K线

## 十九、Logger 设计

### 19.1 日志系统

使用Python标准库`logging`，支持：
- 控制台输出
- 文件输出（轮转）
- 不同日志级别

### 19.2 日志配置

#### 19.2.1 日志级别

从配置读取`LOG_LEVEL`，支持：DEBUG、INFO、WARNING、ERROR、CRITICAL。

#### 19.2.2 日志文件

- 路径：`LOG_FILE`（默认`logs/qwentradeai.log`）
- 自动创建目录

#### 19.2.3 日志轮转

使用`RotatingFileHandler`：
- 最大文件大小：`LOG_MAX_BYTES`（默认10MB）
- 备份数量：`LOG_BACKUP_COUNT`（默认5）

### 19.3 日志格式

**控制台格式**：
```
%(asctime)s - %(name)s - %(levelname)s - %(message)s
```

**文件格式**：
```
%(asctime)s - %(name)s - %(levelname)s - %(filename)s:%(lineno)d - %(message)s
```

### 19.4 日志使用

```python
from app.utils.logger import logger

logger.info("信息日志")
logger.warning("警告日志")
logger.error("错误日志", exc_info=True)  # 包含堆栈信息
```

## 二十、性能优化

### 20.1 请求队列优化

- 使用优先级队列，重要请求优先执行
- 单线程处理，避免并发问题

### 20.2 批量处理优化

- 技术指标批量计算，减少重复计算
- 数据库批量更新，减少提交次数

### 20.3 缓存机制

- 配置缓存：启动时加载所有配置到内存
- 交易所markets缓存：CCXT自动缓存

### 20.4 连接复用

- 数据库连接：使用连接池
- HTTP连接：requests自动复用连接

## 二十一、监控和调试

### 21.1 请求统计

当前实现中未统计请求数量，可扩展添加：
- 请求总数
- 成功/失败数量
- 平均响应时间

### 21.2 性能监控

可扩展添加：
- 队列长度监控
- 请求延迟监控
- 限流触发次数

### 21.3 日志记录

所有关键操作都记录日志：
- API请求和响应
- 错误和异常
- 配置变更

### 21.4 调试工具

- 日志级别设置为DEBUG可查看详细日志
- 使用`logger.debug()`记录调试信息

### 一、概述
- 1.1 基础设施模块职责
- 1.2 核心组件
- 1.3 设计理念

### 二、APIManager 设计
- 2.1 类结构
- 2.2 初始化流程
- 2.3 依赖关系

### 三、API请求管理
- 3.1 请求封装
  - 3.1.1 APIRequest数据结构
  - 3.1.2 请求优先级
  - 3.1.3 请求回调
- 3.2 请求提交
  - 3.2.1 submit_request方法
  - 3.2.2 请求入队
  - 3.2.3 结果返回
- 3.3 请求队列
  - 3.3.1 PriorityQueue设计
  - 3.3.2 队列大小
  - 3.3.3 队列操作

### 四、优先级调度
- 4.1 优先级定义
  - 4.1.1 STOP_LOSS（优先级1）
  - 4.1.2 TRADE（优先级2）
  - 4.1.3 QUERY（优先级3）
- 4.2 优先级队列
  - 4.2.1 队列实现
  - 4.2.2 优先级比较
- 4.3 调度策略

### 五、限流机制
- 5.1 速率限制
  - 5.1.1 时间窗口算法
  - 5.1.2 请求计数
  - 5.1.3 限流检查
- 5.2 最小间隔
  - 5.2.1 间隔控制
  - 5.2.2 时间戳记录
- 5.3 限流配置
  - 5.3.1 API_RATE_LIMIT
  - 5.3.2 API_RATE_WINDOW
  - 5.3.3 API_MIN_INTERVAL

### 六、重试机制
- 6.1 重试策略
  - 6.1.1 最大重试次数
  - 6.1.2 重试条件
  - 6.1.3 不重试条件
- 6.2 重试实现
  - 6.2.1 重试循环
  - 6.2.2 重试间隔
- 6.3 重试配置
  - 6.3.1 API_MAX_RETRIES
  - 6.3.2 API_REQUEST_TIMEOUT

### 七、工作线程模型
- 7.1 单工作线程设计
- 7.2 线程启动
  - 7.2.1 线程创建
  - 7.2.2 线程运行
- 7.3 线程主循环
  - 7.3.1 队列获取
  - 7.3.2 限流检查
  - 7.3.3 请求执行
  - 7.3.4 回调处理
- 7.4 线程停止
  - 7.4.1 优雅关闭
  - 7.4.2 队列处理完成

### 八、API封装
- 8.1 账户相关API
  - 8.1.1 get_balance
  - 8.1.2 实现细节
- 8.2 市场数据API
  - 8.2.1 get_klines
  - 8.2.2 实现细节
- 8.3 交易相关API
  - 8.3.1 create_order
  - 8.3.2 cancel_order
  - 8.3.3 get_order
  - 8.3.4 实现细节
- 8.4 持仓相关API
  - 8.4.1 get_positions
  - 8.4.2 实现细节
- 8.5 条件单API
  - 8.5.1 create_algo_order
  - 8.5.2 cancel_algo_order
  - 8.5.3 实现细节

### 九、CCXT集成
- 9.1 交易所初始化
  - 9.1.1 交易所选择
  - 9.1.2 配置参数
- 9.2 交易所配置
  - 9.2.1 API密钥配置
  - 9.2.2 沙箱/生产环境
  - 9.2.3 默认类型（永续合约）
- 9.3 CCXT方法调用
  - 9.3.1 方法封装
  - 9.3.2 参数转换

### 十、错误处理
- 10.1 错误分类
  - 10.1.1 网络错误
  - 10.1.2 API错误
  - 10.1.3 认证错误
- 10.2 错误处理策略
  - 10.2.1 认证错误处理
  - 10.2.2 其他错误处理
- 10.3 错误日志
  - 10.3.1 日志级别
  - 10.3.2 日志内容

### 十一、CoinGlassClient 设计
- 11.1 类结构
- 11.2 初始化流程
- 11.3 HTTP客户端

### 十二、CoinGlass API封装
- 12.1 未平仓合约API
- 12.2 市场情绪API
- 12.3 ETF资金流API
- 12.4 恐惧贪婪指数API
- 12.5 爆仓历史API

### 十三、请求限流
- 13.1 限流策略
- 13.2 限流实现
- 13.3 错误重试

### 十四、ConfigManager 设计
- 14.1 类结构
- 14.2 初始化流程
- 14.3 数据库连接

### 十五、配置读取
- 15.1 配置类型
  - 15.1.1 string类型
  - 15.1.2 int类型
  - 15.1.3 float类型
  - 15.1.4 bool类型
- 15.2 配置获取
  - 15.2.1 get_string方法
  - 15.2.2 get_int方法
  - 15.2.3 get_float方法
  - 15.2.4 get_bool方法
- 15.3 默认值处理
- 15.4 配置缓存

### 十六、配置项说明
- 16.1 应用配置
  - 16.1.1 APP_NAME
  - 16.1.2 APP_VERSION
  - 16.1.3 DEBUG
- 16.2 交易所配置
  - 16.2.1 EXCHANGE_API_KEY
  - 16.2.2 EXCHANGE_SECRET
  - 16.2.3 EXCHANGE_PASSPHRASE
  - 16.2.4 EXCHANGE_SANDBOX
- 16.3 技术指标配置
  - 16.3.1 RSI配置
  - 16.3.2 MACD配置
  - 16.3.3 EMA配置
  - 16.3.4 布林带配置
- 16.4 同步配置
  - 16.4.1 K线同步配置
  - 16.4.2 其他同步配置
- 16.5 API配置
  - 16.5.1 限流配置
  - 16.5.2 重试配置
  - 16.5.3 超时配置
- 16.6 WebSocket配置
- 16.7 市场检测器配置

### 十七、IndicatorCalculator 设计
- 17.1 类结构
- 17.2 计算接口

### 十八、技术指标计算
- 18.1 EMA计算
  - 18.1.1 计算方法
  - 18.1.2 参数说明
- 18.2 RSI计算
  - 18.2.1 计算方法
  - 18.2.2 参数说明
- 18.3 MACD计算
  - 18.3.1 计算方法
  - 18.3.2 参数说明
- 18.4 布林带计算
  - 18.4.1 计算方法
  - 18.4.2 参数说明
- 18.5 ATR计算
- 18.6 OBV计算
- 18.7 ADX计算
- 18.8 批量计算优化

### 十九、Logger 设计
- 19.1 日志系统
- 19.2 日志配置
  - 19.2.1 日志级别
  - 19.2.2 日志文件
  - 19.2.3 日志轮转
- 19.3 日志格式
- 19.4 日志使用

### 二十、性能优化
- 20.1 请求队列优化
- 20.2 批量处理优化
- 20.3 缓存机制
- 20.4 连接复用

### 二十一、监控和调试
- 21.1 请求统计
- 21.2 性能监控
- 21.3 日志记录
- 21.4 调试工具

