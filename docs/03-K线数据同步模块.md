# K线数据同步模块

## 一、模块职责

- **K线数据同步**：从交易所API获取K线数据并保存到数据库
- **多周期支持**：支持15分钟、4小时、日线三个周期
- **自动定时同步**：按周期自动同步最新数据
- **历史数据补全**：启动时自动补全历史数据

## 二、支持的周期

| 周期 | 同步频率 | 历史数据 | 数据表 |
|------|----------|----------|--------|
| 15m | 每15分钟整点（00, 15, 30, 45） | 30天前 | klines_15m |
| 4h | 每4小时整点（0:00, 4:00, 8:00...） | 180天前 | klines_4h |
| 1d | 每天0:00 | 600天前 | klines_1d |

## 三、核心功能

### 3.1 定时同步

```python
class KlineSyncManager(threading.Thread):
    def run(self):
        # 启动时补全历史数据
        self._sync_initial_data()
        
        # 主循环：每秒检查是否需要同步
        while not self.stop_event.is_set():
            if self._should_sync_15m(now):
                self._fetch_and_save_klines('15m')
            if self._should_sync_4h(now):
                self._fetch_and_save_klines('4h')
            if self._should_sync_1d(now):
                self._fetch_and_save_klines('1d')
```

### 3.2 历史数据补全

- **智能补全**：检测数据断点，只补全缺失数据
- **批量获取**：分页获取历史数据，避免API限流
- **优先级**：先补全最近数据，再补全完整历史

### 3.3 指标自动计算

- K线数据保存后自动计算技术指标
- 支持实时更新和批量更新

## 四、同步机制

### 4.1 同步判断

```python
# 15分钟K线：在整点分钟（00, 15, 30, 45）且秒数<10时执行
if minute % 15 == 0 and second < 10:
    # 距离上次同步超过10分钟才执行
    if (now - last_sync).total_seconds() > 600:
        sync()

# 4小时K线：在整点小时（0, 4, 8, 12, 16, 20）且分钟<10时执行
if hour % 4 == 0 and minute < 10:
    # 距离上次同步超过3小时才执行
    if (now - last_sync).total_seconds() > 10800:
        sync()

# 日线：在0点且分钟<10时执行
if hour == 0 and minute < 10:
    # 距离上次同步超过20小时才执行
    if (now - last_sync).total_seconds() > 72000:
        sync()
```

### 4.2 数据流程

```
1. 从API获取K线数据（CCXT格式）
   └─> api_manager.get_klines(symbol, timeframe, limit, since)

2. 转换数据格式
   └─> 转换为数据库格式（time, open, high, low, close, volume）

3. 保存到数据库
   └─> KlineRepository.insert_klines(session, timeframe, symbol, klines)

4. 自动计算指标
   └─> IndicatorCalculator.update_latest_indicators(timeframe, symbol)
```

## 五、使用示例

### 5.1 初始化

```python
from app.components.kline_sync import KlineSyncManager
from app.components.api_manager import APIManager

api_manager = APIManager()
api_manager.start()

# 创建K线同步管理器
kline_sync = KlineSyncManager(api_manager, symbol="ETH")

# 启动同步线程
kline_sync.start()
```

### 5.2 停止同步

```python
kline_sync.stop()
kline_sync.join(timeout=5)
```

### 5.3 查询数据

```python
from app.database.klines import KlineRepository

session = db.get_session()
try:
    # 获取带指标的K线数据
    klines = KlineRepository.get_klines_with_indicators(
        session, '15m', 'ETH', limit=100
    )
finally:
    session.close()
```

## 六、配置参数

从 `system_config` 表读取：

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `KLINE_15M_START_DAYS` | 30 | 15分钟K线初始同步天数 |
| `KLINE_4H_START_DAYS` | 180 | 4小时K线初始同步天数 |
| `KLINE_1D_START_DAYS` | 600 | 日线K线初始同步天数 |

## 七、错误处理

- **API调用失败**：记录错误日志，等待下次同步
- **数据格式错误**：跳过该条数据，记录警告日志
- **数据库连接失败**：重试3次，失败后等待下次同步
- **指标计算失败**：数据仍保存，指标为NULL

## 八、注意事项

1. **时区统一**：所有时间使用UTC时区
2. **数据去重**：数据库主键约束防止重复数据
3. **多币种支持**：每个币种独立线程，互不影响
4. **API限流**：通过API管理器统一限流
5. **资源占用**：多个币种同时同步时注意API限流

