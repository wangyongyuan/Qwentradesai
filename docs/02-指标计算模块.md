# 指标计算模块

## 一、模块职责

- **技术指标计算**：自动计算K线的技术指标
- **实时更新**：K线数据更新后自动计算指标
- **批量更新**：支持批量更新历史指标

## 二、支持的指标

### 2.1 15分钟K线指标

| 指标 | 参数 | 说明 |
|------|------|------|
| EMA | 9, 21, 55 | 指数移动平均线 |
| RSI | 7 | 相对强弱指标 |
| MACD | 8, 17, 9 | 指数平滑异同移动平均线 |
| 布林带 | 20, 2.0 | 布林带（上轨/中轨/下轨/宽度） |
| ATR | 14 | 平均真实波幅 |
| OBV | - | 能量潮指标 |
| OBV_EMA | 9 | OBV的EMA平滑 |
| ADX | 14 | 平均方向性指标 |

### 2.2 4小时K线指标

| 指标 | 参数 | 说明 |
|------|------|------|
| EMA | 9, 21 | 指数移动平均线 |
| RSI | 14 | 相对强弱指标 |
| MACD | 12, 26, 9 | 指数平滑异同移动平均线 |
| 布林带 | 20, 2.0 | 布林带 |
| OBV | - | 能量潮指标 |

### 2.3 日线指标

| 指标 | 参数 | 说明 |
|------|------|------|
| EMA | 9, 21 | 指数移动平均线 |

## 三、核心功能

### 3.1 指标计算方法

```python
class IndicatorCalculator:
    def calculate_ema(df, period)      # EMA计算
    def calculate_rsi(df, period)     # RSI计算
    def calculate_macd(df, fast, slow, signal)  # MACD计算
    def calculate_bollinger_bands(df, period, std_dev)  # 布林带计算
    def calculate_atr(df, period)     # ATR计算
    def calculate_obv(df)             # OBV计算
    def calculate_adx(df, period)     # ADX计算
```

### 3.2 更新机制

#### 实时更新
```python
# K线数据保存后自动更新最新指标
indicator_calculator.update_latest_indicators('15m', 'ETH')
```

#### 批量更新
```python
# 批量更新所有历史指标
indicator_calculator.batch_update_all_indicators('15m', 'ETH')
```

## 四、数据要求

### 4.1 最小数据量

| 周期 | 最小数据量 | 说明 |
|------|-----------|------|
| 15m | 55根 | EMA55需要55根，ADX需要28根 |
| 4h | 26根 | MACD需要26根 |
| 1d | 21根 | EMA21需要21根 |

### 4.2 计算顺序

1. 基础指标（EMA, RSI）
2. 复合指标（MACD, 布林带）
3. 衍生指标（ATR, OBV, ADX）
4. 宽度指标（布林带宽度）

## 五、使用示例

### 5.1 初始化

```python
from app.components.indicator_calculator import IndicatorCalculator

calculator = IndicatorCalculator()
```

### 5.2 更新指标

```python
# 更新最新K线指标
calculator.update_latest_indicators('15m', 'ETH')

# 批量更新所有历史指标
count = calculator.batch_update_all_indicators('15m', 'ETH')
```

### 5.3 查询指标

```python
from app.database.klines import KlineRepository

# 获取带指标的K线数据
klines = KlineRepository.get_klines_with_indicators(
    session, '15m', 'ETH', limit=100
)

# 访问指标
latest = klines[-1]
rsi = latest['rsi_7']
macd = latest['macd_line']
```

## 六、配置参数

从 `system_config` 表读取：

| 配置项 | 15m | 4h | 说明 |
|--------|-----|----|----|
| RSI周期 | 7 | 14 | RSI计算周期 |
| MACD快线 | 8 | 12 | MACD快线周期 |
| MACD慢线 | 17 | 26 | MACD慢线周期 |
| MACD信号 | 9 | 9 | MACD信号线周期 |
| EMA短期 | 9 | 9 | EMA短期周期 |
| EMA中期 | 21 | 21 | EMA中期周期 |
| EMA长期 | 55 | - | EMA长期周期（仅15m） |
| 布林带周期 | 20 | 20 | 布林带周期 |
| 布林带倍数 | 2.0 | 2.0 | 布林带标准差倍数 |
| ATR周期 | 14 | - | ATR计算周期（仅15m） |

## 七、注意事项

1. **数据完整性**：指标计算需要足够的历史数据
2. **计算顺序**：某些指标依赖其他指标，需要按顺序计算
3. **NaN处理**：数据不足时指标值为NULL
4. **性能优化**：批量更新时使用批量提交，提高效率
5. **错误处理**：计算失败不影响K线数据保存

