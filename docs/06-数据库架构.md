# 数据库架构文档

## 一、概述

### 1.1 数据库选型（PostgreSQL）

**选择PostgreSQL的原因**：
- **功能强大**：支持JSONB、数组、时间戳等高级数据类型
- **性能优秀**：查询性能好，支持复杂查询和索引优化
- **可靠性高**：ACID事务支持，数据一致性保证
- **扩展性强**：支持自定义函数、触发器、存储过程等
- **开源免费**：无商业授权限制

**使用场景**：
- 存储K线数据和技术指标
- 存储市场数据（资金费率、持仓量、市场情绪等）
- 存储交易数据（订单历史、持仓历史、交易信号等）
- 存储系统配置和状态

### 1.2 数据库设计原则

**设计原则**：
- **规范化设计**：遵循第三范式，减少数据冗余
- **主键设计**：使用复合主键（symbol, time）确保唯一性
- **索引优化**：为常用查询字段创建索引，提高查询性能
- **数据类型**：使用合适的数据类型（DECIMAL用于价格，TIMESTAMPTZ用于时间）
- **约束设计**：使用主键、唯一索引、非空约束保证数据完整性

**命名规范**：
- **表名**：小写字母+下划线，如`klines_15m`、`funding_rate_history`
- **字段名**：小写字母+下划线，如`symbol`、`created_at`
- **索引名**：`idx_表名_字段名`，如`idx_klines_15m_symbol_time`

### 1.3 数据访问模式

**Repository模式**：
- **设计模式**：使用Repository模式封装数据访问逻辑
- **优势**：解耦业务逻辑和数据访问，便于测试和维护
- **实现方式**：每个表对应一个Repository类，提供CRUD方法

**会话管理**：
- **会话获取**：通过`db.get_session()`获取数据库会话
- **上下文管理**：使用`with`语句自动管理会话生命周期
- **事务管理**：自动提交或手动提交，异常时自动回滚

## 二、数据库连接管理

### 2.1 连接池配置

**连接池参数**：
- **pool_size**：10（连接池大小）
- **max_overflow**：20（最大溢出连接数）
- **pool_pre_ping**：True（连接前检查，自动重连失效连接）
- **pool_recycle**：3600（1小时回收连接，避免连接超时）

**连接池优势**：
- **性能优化**：复用连接，减少连接建立开销
- **资源管理**：限制连接数，防止资源耗尽
- **自动恢复**：连接失效时自动重连

### 2.2 连接URL格式

**URL格式**：
```
postgresql://用户名:密码@主机:端口/数据库名
```

**示例**：
```
postgresql://qwentradeai:qwentradeai@45.197.144.57:5432/qwentradeai
```

**配置来源**：
- **环境变量**：`DATABASE_URL`
- **配置文件**：`.env`文件
- **数据库配置**：`system_config`表（如果数据库可用）

### 2.3 会话管理

**会话获取**：
```python
with db.get_session() as session:
    # 使用session进行数据库操作
    pass
```

**会话特点**：
- **自动关闭**：使用`with`语句自动关闭会话
- **线程安全**：每个线程使用独立的会话
- **事务管理**：默认不自动提交，需要手动`commit()`

### 2.4 事务管理

**自动提交**：
- **默认行为**：不自动提交，需要手动调用`session.commit()`
- **异常回滚**：发生异常时自动回滚

**手动提交**：
```python
with db.get_session() as session:
    # 执行数据库操作
    session.execute(sql, params)
    session.commit()  # 手动提交
```

**异常处理**：
```python
try:
    with db.get_session() as session:
        session.execute(sql, params)
        session.commit()
except Exception as e:
    session.rollback()  # 自动回滚
    logger.error(f"数据库操作失败: {e}")
```

## 三、K线数据表设计

### 3.1 klines_15m表

**3.1.1 表结构**：
```sql
CREATE TABLE klines_15m (
    symbol VARCHAR(20) NOT NULL,
    time TIMESTAMPTZ NOT NULL,
    open DECIMAL(20, 8) NOT NULL,
    high DECIMAL(20, 8) NOT NULL,
    low DECIMAL(20, 8) NOT NULL,
    close DECIMAL(20, 8) NOT NULL,
    volume DECIMAL(20, 8) NOT NULL,
    ema_9 DECIMAL(20, 8),
    ema_21 DECIMAL(20, 8),
    ema_55 DECIMAL(20, 8),
    rsi_7 DECIMAL(10, 4),
    macd_line DECIMAL(20, 8),
    signal_line DECIMAL(20, 8),
    histogram DECIMAL(20, 8),
    bb_upper DECIMAL(20, 8),
    bb_middle DECIMAL(20, 8),
    bb_lower DECIMAL(20, 8),
    atr_14 DECIMAL(20, 8),
    obv DECIMAL(20, 8),
    obv_ema_9 DECIMAL(20, 8),
    adx_14 DECIMAL(10, 4),
    bb_width DECIMAL(10, 6),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (symbol, time)
);
```

**3.1.2 主键设计**：
- **主键**：`(symbol, time)`（复合主键）
- **唯一性**：确保同一币种同一时间只有一条记录
- **查询优化**：主键自动创建索引，提高查询性能

**3.1.3 索引设计**：
- **idx_klines_15m_symbol**：`symbol`字段索引（按币种查询）
- **idx_klines_15m_time**：`time`字段索引（按时间查询）
- **idx_klines_15m_symbol_time**：`(symbol, time DESC)`复合索引（按币种和时间范围查询）

**3.1.4 字段说明**：
- **基础K线数据**：`open`、`high`、`low`、`close`、`volume`
- **EMA指标**：`ema_9`（短期）、`ema_21`（中期）、`ema_55`（长期）
- **RSI指标**：`rsi_7`（周期7，阈值20/80）
- **MACD指标**：`macd_line`、`signal_line`、`histogram`（参数8,17,9）
- **布林带指标**：`bb_upper`、`bb_middle`、`bb_lower`（参数20,2）
- **ATR指标**：`atr_14`（周期14）
- **OBV指标**：`obv`、`obv_ema_9`
- **ADX指标**：`adx_14`（周期14，>25表示趋势市）
- **布林带宽度**：`bb_width`（(上轨-下轨)/中轨，判断波动率）

### 3.2 klines_4h表

**3.2.1 表结构**：
```sql
CREATE TABLE klines_4h (
    symbol VARCHAR(20) NOT NULL,
    time TIMESTAMPTZ NOT NULL,
    open DECIMAL(20, 8) NOT NULL,
    high DECIMAL(20, 8) NOT NULL,
    low DECIMAL(20, 8) NOT NULL,
    close DECIMAL(20, 8) NOT NULL,
    volume DECIMAL(20, 8) NOT NULL,
    ema_9 DECIMAL(20, 8),
    ema_21 DECIMAL(20, 8),
    rsi_14 DECIMAL(10, 4),
    macd_line DECIMAL(20, 8),
    signal_line DECIMAL(20, 8),
    histogram DECIMAL(20, 8),
    bb_upper DECIMAL(20, 8),
    bb_middle DECIMAL(20, 8),
    bb_lower DECIMAL(20, 8),
    obv DECIMAL(20, 8),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (symbol, time)
);
```

**3.2.2 主键设计**：
- **主键**：`(symbol, time)`（复合主键）
- **与15m表相同**：使用相同的设计模式

**3.2.3 索引设计**：
- **idx_klines_4h_symbol**：`symbol`字段索引
- **idx_klines_4h_time**：`time`字段索引
- **idx_klines_4h_symbol_time**：`(symbol, time DESC)`复合索引

**3.2.4 字段说明**：
- **基础K线数据**：与15m表相同
- **EMA指标**：`ema_9`、`ema_21`（中期和长期趋势）
- **RSI指标**：`rsi_14`（周期14，阈值30/70）
- **MACD指标**：`macd_line`、`signal_line`、`histogram`（参数12,26,9）
- **布林带指标**：`bb_upper`、`bb_middle`、`bb_lower`（参数20,2）
- **OBV指标**：`obv`（用于确认大方向趋势）

### 3.3 klines_1d表

**3.3.1 表结构**：
```sql
CREATE TABLE klines_1d (
    symbol VARCHAR(20) NOT NULL,
    time TIMESTAMPTZ NOT NULL,
    open DECIMAL(20, 8) NOT NULL,
    high DECIMAL(20, 8) NOT NULL,
    low DECIMAL(20, 8) NOT NULL,
    close DECIMAL(20, 8) NOT NULL,
    volume DECIMAL(20, 8) NOT NULL,
    ema_9 DECIMAL(20, 8),
    ema_21 DECIMAL(20, 8),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (symbol, time)
);
```

**3.3.2 主键设计**：
- **主键**：`(symbol, time)`（复合主键）
- **与15m/4h表相同**：使用相同的设计模式

**3.3.3 索引设计**：
- **idx_klines_1d_symbol**：`symbol`字段索引
- **idx_klines_1d_time**：`time`字段索引
- **idx_klines_1d_symbol_time**：`(symbol, time DESC)`复合索引

**3.3.4 字段说明**：
- **基础K线数据**：与15m/4h表相同
- **EMA指标**：`ema_9`、`ema_21`（长期趋势判断）
- **简化设计**：日线表只保留基础K线数据和EMA指标，用于长期趋势判断

## 四、市场数据表设计

### 4.1 funding_rate表

**4.1.1 表结构**：
```sql
CREATE TABLE funding_rate_history (
    symbol VARCHAR(20) NOT NULL,
    time TIMESTAMPTZ NOT NULL,
    funding_rate DECIMAL(20, 8) NOT NULL,
    open_interest DECIMAL(20, 8),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (symbol, time)
);
```

**4.1.2 主键和索引**：
- **主键**：`(symbol, time)`（复合主键）
- **索引**：
  - `idx_funding_rate_symbol`：`symbol`字段索引
  - `idx_funding_rate_time`：`time`字段索引
  - `idx_funding_rate_symbol_time`：`(symbol, time DESC)`复合索引

**4.1.3 字段说明**：
- **symbol**：币种名称（BTC、ETH等）
- **time**：资金费率时间（每8小时一次）
- **funding_rate**：资金费率（正数表示做多付费，负数表示做空付费）
- **open_interest**：持仓量（可选）

### 4.2 open_interest表

**4.2.1 表结构**：
```sql
CREATE TABLE open_interest_15m (
    symbol VARCHAR(20) NOT NULL,
    time TIMESTAMPTZ NOT NULL,
    open_interest DECIMAL(20, 8) NOT NULL,
    open_interest_usd DECIMAL(30, 2),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (symbol, time)
);
```

**4.2.2 主键和索引**：
- **主键**：`(symbol, time)`（复合主键）
- **索引**：
  - `idx_open_interest_15m_symbol`：`symbol`字段索引
  - `idx_open_interest_15m_time`：`time`字段索引
  - `idx_open_interest_15m_symbol_time`：`(symbol, time DESC)`复合索引

**4.2.3 字段说明**：
- **symbol**：币种名称
- **time**：时间戳（15分钟周期）
- **open_interest**：持仓量（币数量）
- **open_interest_usd**：持仓量（美元价值）

### 4.3 market_sentiment表

**4.3.1 表结构**：
```sql
CREATE TABLE market_sentiment_data (
    symbol VARCHAR(20) NOT NULL,
    time TIMESTAMPTZ NOT NULL,
    long_short_ratio DECIMAL(10, 4) NOT NULL,
    long_account_ratio DECIMAL(10, 4),
    short_account_ratio DECIMAL(10, 4),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (symbol, time)
);
```

**4.3.2 主键和索引**：
- **主键**：`(symbol, time)`（复合主键）
- **索引**：
  - `idx_market_sentiment_symbol`：`symbol`字段索引
  - `idx_market_sentiment_time`：`time`字段索引
  - `idx_market_sentiment_symbol_time`：`(symbol, time DESC)`复合索引

**4.3.3 字段说明**：
- **symbol**：币种名称
- **time**：时间戳
- **long_short_ratio**：多空比（>1表示做多占优，<1表示做空占优）
- **long_account_ratio**：做多账户比例
- **short_account_ratio**：做空账户比例

### 4.4 order_book表

**4.4.1 表结构**：
```sql
CREATE TABLE order_book_distribution (
    symbol VARCHAR(20) NOT NULL,
    time TIMESTAMPTZ NOT NULL,
    bids JSONB,
    asks JSONB,
    bid_total DECIMAL(20, 8),
    ask_total DECIMAL(20, 8),
    bid_ask_ratio DECIMAL(10, 4),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (symbol, time)
);
```

**4.4.2 主键和索引**：
- **主键**：`(symbol, time)`（复合主键）
- **索引**：
  - `idx_order_book_symbol`：`symbol`字段索引
  - `idx_order_book_time`：`time`字段索引
  - `idx_order_book_symbol_time`：`(symbol, time DESC)`复合索引

**4.4.3 字段说明（JSON格式）**：
- **symbol**：币种名称
- **time**：时间戳
- **bids**：买盘深度（JSONB格式，包含价格和数量）
- **asks**：卖盘深度（JSONB格式，包含价格和数量）
- **bid_total**：买盘总量
- **ask_total**：卖盘总量
- **bid_ask_ratio**：买卖盘比例

### 4.5 etf_flow表

**4.5.1 表结构**：
```sql
CREATE TABLE etf_flow_data (
    symbol VARCHAR(20) NOT NULL,
    date DATE NOT NULL,
    net_flow DECIMAL(20, 8) NOT NULL,
    inflow DECIMAL(20, 8),
    outflow DECIMAL(20, 8),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (symbol, date)
);
```

**4.5.2 主键和索引**：
- **主键**：`(symbol, date)`（复合主键）
- **索引**：
  - `idx_etf_flow_symbol`：`symbol`字段索引
  - `idx_etf_flow_date`：`date`字段索引
  - `idx_etf_flow_symbol_date`：`(symbol, date DESC)`复合索引

**4.5.3 字段说明**：
- **symbol**：币种名称（BTC、ETH）
- **date**：日期（每天一条记录）
- **net_flow**：净流入（正数表示流入，负数表示流出）
- **inflow**：流入量
- **outflow**：流出量

### 4.6 fear_greed表

**4.6.1 表结构**：
```sql
CREATE TABLE fear_greed_index (
    date DATE NOT NULL PRIMARY KEY,
    value INTEGER NOT NULL,
    classification VARCHAR(20),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**4.6.2 主键和索引**：
- **主键**：`date`（单字段主键，每天一条记录）
- **索引**：
  - `idx_fear_greed_date`：`date DESC`索引（按日期倒序查询）

**4.6.3 字段说明**：
- **date**：日期（主键，每天一条记录）
- **value**：恐惧贪婪指数值（0-100，0=极度恐惧，100=极度贪婪）
- **classification**：分类（Extreme Fear、Fear、Neutral、Greed、Extreme Greed）

### 4.7 liquidation表

**4.7.1 表结构**：
```sql
CREATE TABLE liquidation_history (
    symbol VARCHAR(20) NOT NULL,
    time TIMESTAMPTZ NOT NULL,
    liquidation_amount DECIMAL(20, 8) NOT NULL,
    liquidation_usd DECIMAL(30, 2),
    long_liquidation DECIMAL(20, 8),
    short_liquidation DECIMAL(20, 8),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (symbol, time)
);
```

**4.7.2 主键和索引**：
- **主键**：`(symbol, time)`（复合主键）
- **索引**：
  - `idx_liquidation_symbol`：`symbol`字段索引
  - `idx_liquidation_time`：`time`字段索引
  - `idx_liquidation_symbol_time`：`(symbol, time DESC)`复合索引

**4.7.3 字段说明**：
- **symbol**：币种名称
- **time**：时间戳
- **liquidation_amount**：爆仓数量（币数量）
- **liquidation_usd**：爆仓金额（美元）
- **long_liquidation**：做多爆仓数量
- **short_liquidation**：做空爆仓数量

## 五、交易数据表设计

### 5.1 order_history表

**5.1.1 表结构**：
```sql
CREATE TABLE order_history (
    ord_id VARCHAR(50) PRIMARY KEY,
    cl_ord_id VARCHAR(50),
    inst_id VARCHAR(50) NOT NULL,
    symbol VARCHAR(20) NOT NULL,
    inst_type VARCHAR(20) NOT NULL,
    ord_type VARCHAR(20),
    side VARCHAR(10),
    pos_side VARCHAR(10),
    sz DECIMAL(20, 8),
    px DECIMAL(20, 8),
    acc_fill_sz DECIMAL(20, 8),
    fill_px DECIMAL(20, 8),
    fill_time_ms BIGINT,
    fill_time TIMESTAMPTZ,
    state VARCHAR(20),
    c_time_ms BIGINT NOT NULL,
    c_time TIMESTAMPTZ NOT NULL,
    u_time_ms BIGINT NOT NULL,
    u_time TIMESTAMPTZ NOT NULL,
    raw_data JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**5.1.2 主键和索引**：
- **主键**：`ord_id`（单字段主键，OKX订单ID）
- **索引**：
  - `idx_order_history_symbol`：`symbol`字段索引
  - `idx_order_history_cl_ord_id`：`cl_ord_id`字段索引
  - `idx_order_history_state`：`state`字段索引
  - `idx_order_history_c_time`：`c_time DESC`索引
  - `idx_order_history_symbol_time`：`(symbol, c_time DESC)`复合索引
  - `idx_order_history_fill_time`：`fill_time DESC`索引（条件索引，fill_time不为空）

**5.1.3 字段说明**：
- **基础信息**：`ord_id`（订单ID）、`cl_ord_id`（客户端订单ID）、`inst_id`（产品ID）
- **订单参数**：`sz`（数量）、`px`（价格）、`side`（方向）、`pos_side`（持仓方向）
- **成交信息**：`acc_fill_sz`（累计成交数量）、`fill_px`（成交价格）、`fill_time`（成交时间）
- **订单状态**：`state`（filled/partially_filled/canceled等）
- **时间字段**：`c_time`（创建时间）、`u_time`（更新时间）、`fill_time`（成交时间）
- **原始数据**：`raw_data`（JSONB格式，存储完整API响应）

**5.1.4 订单状态枚举**：
- **filled**：已完全成交
- **partially_filled**：部分成交
- **canceled**：已取消
- **live**：未成交
- **effective**：有效（部分成交）

### 5.2 position_history表

**5.2.1 表结构**：
```sql
CREATE TABLE position_history (
    id BIGSERIAL PRIMARY KEY,
    inst_id VARCHAR(50) NOT NULL,
    symbol VARCHAR(20) NOT NULL,
    pos_id VARCHAR(50) NOT NULL,
    pos_side VARCHAR(10),
    open_avg_px DECIMAL(20, 8),
    close_avg_px DECIMAL(20, 8),
    realized_pnl DECIMAL(20, 8),
    pnl DECIMAL(20, 8),
    type VARCHAR(10),
    c_time_ms BIGINT NOT NULL,
    c_time TIMESTAMPTZ NOT NULL,
    u_time_ms BIGINT NOT NULL,
    u_time TIMESTAMPTZ NOT NULL,
    raw_data JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE (pos_id, c_time)
);
```

**5.2.2 主键和索引（复合主键）**：
- **主键**：`id`（自增主键）
- **唯一约束**：`(pos_id, c_time)`（同一仓位同一开仓时间只有一条记录）
- **索引**：
  - `idx_position_history_symbol`：`symbol`字段索引
  - `idx_position_history_pos_id`：`pos_id`字段索引
  - `idx_position_history_type`：`type`字段索引
  - `idx_position_history_u_time`：`u_time DESC`索引
  - `idx_position_history_symbol_time`：`(symbol, u_time DESC)`复合索引

**5.2.3 字段说明**：
- **基础信息**：`inst_id`（产品ID）、`symbol`（币种名称）、`pos_id`（持仓ID）
- **价格信息**：`open_avg_px`（开仓均价）、`close_avg_px`（平仓均价）
- **收益信息**：`realized_pnl`（已实现收益）、`pnl`（收益）
- **平仓类型**：`type`（1=部分平仓，2=完全平仓，3=强平，4=强减，5/6=ADL自动减仓）
- **时间字段**：`c_time`（开仓时间）、`u_time`（更新时间）

### 5.3 market_signal表

**5.3.1 表结构**：
```sql
CREATE TABLE market_signals (
    id BIGSERIAL PRIMARY KEY,
    snapshot_id BIGINT REFERENCES market_detection_snapshots(id),
    symbol VARCHAR(20) NOT NULL,
    signal_type VARCHAR(20) NOT NULL,
    detected_at TIMESTAMPTZ NOT NULL,
    price DECIMAL(20, 8) NOT NULL,
    confidence_score DECIMAL(10, 2) NOT NULL,
    signal_strength VARCHAR(20) NOT NULL,
    position_size_multiplier DECIMAL(5, 2) DEFAULT 1.0,
    kline_15m_time TIMESTAMPTZ NOT NULL,
    kline_4h_time TIMESTAMPTZ NOT NULL,
    trigger_factors JSONB,
    market_mode VARCHAR(20),
    multi_tf_aligned BOOLEAN DEFAULT FALSE,
    status VARCHAR(20) DEFAULT 'PENDING',
    expired_at TIMESTAMPTZ,
    trade_id VARCHAR(32),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**5.3.2 主键和索引**：
- **主键**：`id`（自增主键）
- **外键**：`snapshot_id`（关联market_detection_snapshots表）
- **索引**：
  - `idx_signals_symbol`：`symbol`字段索引
  - `idx_signals_time`：`detected_at DESC`索引
  - `idx_signals_status`：`(status, detected_at DESC)`复合索引
  - `idx_signals_strength`：`(signal_strength, detected_at DESC)`复合索引
  - `idx_signals_confidence`：`(confidence_score DESC, detected_at DESC)`复合索引

**5.3.3 字段说明**：
- **信号信息**：`signal_type`（LONG/SHORT）、`confidence_score`（置信度分数0-100）
- **信号强度**：`signal_strength`（WEAK/MODERATE/STRONG/VERY_STRONG）
- **仓位倍数**：`position_size_multiplier`（1.0=正常，2.0=加倍）
- **触发因素**：`trigger_factors`（JSONB格式，存储触发因素数组）
- **市场环境**：`market_mode`（BULL/BEAR）、`multi_tf_aligned`（多时间框架对齐）
- **信号状态**：`status`（PENDING/ACTIVE/EXPIRED/FILLED/CANCELLED）

**5.3.4 details JSON字段结构**：
- **trigger_factors**：`["momentum_turn", "volume_surge", "ema_cross"]`（触发因素数组）
- **indicators_snapshot**：技术指标快照（RSI、MACD等）

### 5.4 pending_order表

**5.4.1 表结构**：
```sql
CREATE TABLE pending_orders (
    id BIGSERIAL PRIMARY KEY,
    symbol VARCHAR(20) NOT NULL,
    side VARCHAR(10) NOT NULL,
    amount DECIMAL(20, 8) NOT NULL,
    trigger_price DECIMAL(20, 8) NOT NULL,
    stop_loss_trigger DECIMAL(20, 8) NOT NULL,
    take_profit_trigger DECIMAL(20, 8) NOT NULL,
    leverage DECIMAL(10, 2) NOT NULL,
    signal_id BIGINT,
    status VARCHAR(20) NOT NULL DEFAULT 'PENDING',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    expired_at TIMESTAMPTZ NOT NULL,
    triggered_at TIMESTAMPTZ,
    filled_at TIMESTAMPTZ,
    error_message TEXT,
    cl_ord_id VARCHAR(32),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**5.4.2 主键和索引**：
- **主键**：`id`（自增主键）
- **索引**：
  - `idx_pending_orders_symbol`：`symbol`字段索引
  - `idx_pending_orders_status`：`status`字段索引
  - `idx_pending_orders_expired_at`：`expired_at`字段索引
  - `idx_pending_orders_status_expired`：`(status, expired_at)`复合索引

**5.4.3 字段说明**：
- **挂单信息**：`symbol`（币种）、`side`（LONG/SHORT）、`amount`（数量）
- **触发条件**：`trigger_price`（触发价格）
- **止损止盈**：`stop_loss_trigger`、`take_profit_trigger`
- **杠杆倍数**：`leverage`
- **状态和时间**：`status`、`created_at`、`expired_at`、`triggered_at`、`filled_at`

**5.4.4 挂单状态枚举**：
- **PENDING**：待触发
- **EXPIRED**：已过期
- **FILLED**：已成交
- **FAILED**：失败
- **CANCELLED**：已取消

### 5.5 trading_relations表

**5.5.1 表结构**：
```sql
CREATE TABLE trading_relations (
    id BIGSERIAL PRIMARY KEY,
    signal_id BIGINT NOT NULL,
    cl_ord_id VARCHAR(32) NOT NULL,
    ord_id VARCHAR(50),
    position_history_id BIGINT,
    operation_type VARCHAR(20) NOT NULL,
    amount DECIMAL(20, 8),
    price DECIMAL(20, 8),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**5.5.2 主键和索引**：
- **主键**：`id`（自增主键）
- **索引**：
  - `idx_trading_relations_signal_id`：`signal_id`字段索引
  - `idx_trading_relations_cl_ord_id`：`cl_ord_id`字段索引
  - `idx_trading_relations_ord_id`：`ord_id`字段索引
  - `idx_trading_relations_position_history_id`：`position_history_id`字段索引
  - `idx_trading_relations_signal_cl_ord`：`(signal_id, cl_ord_id)`复合索引

**5.5.3 字段说明**：
- **关联信息**：`signal_id`（信号ID）、`cl_ord_id`（客户端订单ID）、`ord_id`（订单ID）、`position_history_id`（持仓历史ID）
- **操作信息**：`operation_type`（操作类型）、`amount`（数量）、`price`（价格）

**5.5.4 交易状态枚举**：
- **open**：开仓
- **add**：加仓
- **reduce**：减仓
- **close**：平仓
- **set_stop_loss_take_profit**：设置止损止盈

## 六、系统表设计

### 6.1 config表

**6.1.1 表结构**：
```sql
CREATE TABLE system_config (
    id SERIAL PRIMARY KEY,
    config_key VARCHAR(255) UNIQUE NOT NULL,
    value TEXT NOT NULL,
    value_type VARCHAR(50) DEFAULT 'string' NOT NULL,
    description TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**6.1.2 主键设计**：
- **主键**：`id`（自增主键）
- **唯一约束**：`config_key`（配置键名唯一）

**6.1.3 字段说明**：
- **config_key**：配置键名（如APP_NAME、DATABASE_URL等）
- **value**：配置值（文本格式，支持JSON）
- **value_type**：配置类型（string/int/float/boolean/json）
- **description**：配置说明

**6.1.4 配置类型枚举**：
- **string**：字符串类型
- **int**：整数类型
- **float**：浮点数类型
- **boolean**：布尔类型
- **json**：JSON格式（复杂配置）

### 6.2 system_status表

**6.2.1 表结构**：
```sql
CREATE TABLE system_status (
    id SERIAL PRIMARY KEY,
    key VARCHAR(100) UNIQUE NOT NULL,
    value TEXT NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**6.2.2 主键设计**：
- **主键**：`id`（自增主键）
- **唯一约束**：`key`（状态键名唯一）

**6.2.3 字段说明**：
- **key**：状态键名（如last_sync_time、system_status等）
- **value**：状态值（文本格式）
- **updated_at**：更新时间

## 七、Repository模式

### 7.1 Repository设计原则

**设计原则**：
- **单一职责**：每个Repository只负责一个表的数据访问
- **静态方法**：使用静态方法，避免实例化
- **会话注入**：通过参数注入数据库会话，便于事务管理
- **错误处理**：统一的错误处理和日志记录
- **类型转换**：自动处理数据类型转换（Decimal、datetime等）

**命名规范**：
- **类名**：`表名Repository`（如`KlineRepository`、`OrderHistoryRepository`）
- **方法名**：`操作_表名`（如`insert_klines`、`get_latest_funding_rate_time`）

### 7.2 Repository列表

**7.2.1 KlineRepository**：
- **职责**：K线数据访问（15m、4h、1d）
- **主要方法**：
  - `insert_klines()`：批量插入K线数据
  - `get_klines()`：查询K线数据
  - `get_latest_kline_time()`：获取最新K线时间

**7.2.2 FundingRateRepository**：
- **职责**：资金费率数据访问
- **主要方法**：
  - `insert_funding_rate()`：插入资金费率
  - `get_latest_funding_rate_time()`：获取最新资金费率时间

**7.2.3 OpenInterestRepository**：
- **职责**：持仓量数据访问
- **主要方法**：
  - `insert_open_interest()`：插入持仓量数据
  - `get_latest_open_interest_time()`：获取最新持仓量时间

**7.2.4 MarketSentimentRepository**：
- **职责**：市场情绪数据访问
- **主要方法**：
  - `insert_sentiment()`：插入市场情绪数据
  - `get_latest_sentiment_time()`：获取最新市场情绪时间

**7.2.5 OrderBookRepository**：
- **职责**：订单簿数据访问
- **主要方法**：
  - `insert_order_book()`：插入订单簿数据
  - `get_latest_order_book_time()`：获取最新订单簿时间

**7.2.6 ETFFlowRepository**：
- **职责**：ETF资金流数据访问
- **主要方法**：
  - `insert_etf_flow()`：插入ETF资金流数据
  - `get_latest_etf_flow_date()`：获取最新ETF资金流日期

**7.2.7 FearGreedRepository**：
- **职责**：恐惧贪婪指数数据访问
- **主要方法**：
  - `insert_fear_greed()`：插入恐惧贪婪指数
  - `get_latest_fear_greed_date()`：获取最新恐惧贪婪指数日期

**7.2.8 LiquidationRepository**：
- **职责**：爆仓历史数据访问
- **主要方法**：
  - `insert_liquidation()`：插入爆仓数据
  - `get_latest_liquidation_time()`：获取最新爆仓时间

**7.2.9 OrderHistoryRepository**：
- **职责**：订单历史数据访问
- **主要方法**：
  - `insert_order()`：插入订单数据
  - `get_order_by_ord_id()`：根据订单ID查询
  - `get_orders_by_cl_ord_id()`：根据客户端订单ID查询

**7.2.10 PositionHistoryRepository**：
- **职责**：持仓历史数据访问
- **主要方法**：
  - `insert_position()`：插入持仓数据
  - `get_position_by_pos_id()`：根据持仓ID查询
  - `get_latest_position_time()`：获取最新持仓时间

**7.2.11 MarketSignalRepository**：
- **职责**：市场信号数据访问
- **主要方法**：
  - `insert_signal()`：插入市场信号
  - `get_latest_signal()`：获取最新信号
  - `get_signals()`：获取信号列表
  - `update_signal_processed()`：更新信号处理状态

**7.2.12 PendingOrderRepository**：
- **职责**：挂单数据访问
- **主要方法**：
  - `create_pending_order()`：创建挂单
  - `get_pending_order_by_id()`：根据ID查询挂单
  - `get_pending_orders_by_status()`：根据状态查询挂单列表
  - `cancel_pending_order()`：取消挂单
  - `mark_expired_orders()`：标记过期挂单

**7.2.13 TradingRelationsRepository**：
- **职责**：交易关联数据访问
- **主要方法**：
  - `insert_relation()`：插入交易关联记录
  - `get_relations_by_cl_ord_id()`：根据clOrdId查询关联记录
  - `get_relations_by_signal_id()`：根据signalId查询关联记录
  - `get_ord_ids_by_cl_ord_id()`：根据clOrdId查询订单ID列表

**7.2.14 ConfigManager**：
- **职责**：系统配置管理
- **主要方法**：
  - `get()`：获取配置值
  - `get_string()`：获取字符串配置
  - `get_int()`：获取整数配置
  - `get_float()`：获取浮点数配置
  - `get_bool()`：获取布尔配置
  - `set()`：设置配置值
  - `reload()`：重新加载配置

## 八、数据访问操作

### 8.1 插入操作

**8.1.1 单条插入**：
```python
with db.get_session() as session:
    KlineRepository.insert_klines(
        session=session,
        timeframe='15m',
        symbol='ETH',
        klines=[{...}]
    )
```

**8.1.2 批量插入**：
- **方式**：使用`INSERT ... VALUES (...), (...), (...)`批量插入
- **优势**：减少数据库往返次数，提高性能
- **限制**：单次批量插入建议不超过1000条

**8.1.3 ON CONFLICT处理**：
- **方式**：使用`ON CONFLICT DO NOTHING`或`ON CONFLICT DO UPDATE`
- **用途**：避免重复插入，实现幂等性
- **示例**：
  ```sql
  INSERT INTO klines_15m (symbol, time, ...)
  VALUES (:symbol, :time, ...)
  ON CONFLICT (symbol, time) DO NOTHING
  ```

### 8.2 查询操作

**8.2.1 条件查询**：
- **方式**：使用`WHERE`子句
- **参数化查询**：使用参数化查询防止SQL注入
- **示例**：
  ```python
  sql = text("SELECT * FROM klines_15m WHERE symbol = :symbol AND time >= :start_time")
  result = session.execute(sql, {'symbol': 'ETH', 'start_time': start_time})
  ```

**8.2.2 排序和分页**：
- **排序**：使用`ORDER BY`子句（通常按时间倒序）
- **分页**：使用`LIMIT`和`OFFSET`
- **示例**：
  ```sql
  SELECT * FROM market_signals
  ORDER BY detected_at DESC
  LIMIT :limit OFFSET :offset
  ```

**8.2.3 聚合查询**：
- **聚合函数**：`COUNT`、`SUM`、`AVG`、`MAX`、`MIN`
- **分组查询**：使用`GROUP BY`
- **示例**：
  ```sql
  SELECT symbol, COUNT(*) as count, AVG(confidence_score) as avg_score
  FROM market_signals
  GROUP BY symbol
  ```

### 8.3 更新操作

**8.3.1 单条更新**：
```python
sql = text("""
    UPDATE market_signals
    SET status = :status, updated_at = NOW()
    WHERE id = :signal_id
""")
session.execute(sql, {'status': 'FILLED', 'signal_id': signal_id})
session.commit()
```

**8.3.2 批量更新**：
- **方式**：使用`UPDATE ... WHERE ... IN (...)`批量更新
- **限制**：IN子句中的值数量建议不超过1000个

### 8.4 删除操作

**8.4.1 条件删除**：
- **方式**：使用`DELETE FROM ... WHERE ...`
- **注意**：谨慎使用，建议先备份数据

**8.4.2 软删除（标记删除）**：
- **方式**：使用`status`字段标记为已删除，不实际删除数据
- **优势**：保留历史数据，便于回溯分析
- **示例**：`status = 'DELETED'`或`status = 'CANCELLED'`

## 九、数据模型定义

### 9.1 SQLAlchemy模型

**9.1.1 Base类**：
```python
from sqlalchemy.orm import declarative_base
Base = declarative_base()
```

**9.1.2 模型继承**：
- **继承Base**：所有模型类继承`Base`
- **表名映射**：使用`__tablename__`指定表名
- **字段定义**：使用SQLAlchemy的Column定义字段

**模型示例**：
```python
class SystemStatus(Base):
    __tablename__ = 'system_status'
    id = Column(Integer, primary_key=True)
    key = Column(String(100), unique=True, nullable=False)
    value = Column(Text, nullable=False)
    updated_at = Column(DateTime(timezone=True), default=datetime.utcnow)
```

### 9.2 模型关系

**9.2.1 外键关系**：
- **定义方式**：使用`ForeignKey`定义外键
- **示例**：
  ```python
  snapshot_id = Column(BigInteger, ForeignKey('market_detection_snapshots.id'))
  ```

**9.2.2 关系映射**：
- **定义方式**：使用`relationship`定义关系
- **示例**：
  ```python
  snapshot = relationship("MarketDetectionSnapshot", back_populates="signals")
  ```

### 9.3 模型验证

**验证方式**：
- **数据库约束**：使用NOT NULL、UNIQUE、CHECK等约束
- **应用层验证**：在Repository方法中进行参数验证
- **类型转换**：自动处理Decimal、datetime等类型转换

## 十、索引设计

### 10.1 主键索引

**主键索引特点**：
- **自动创建**：主键自动创建唯一索引
- **查询优化**：主键查询性能最优
- **复合主键**：支持复合主键（如`(symbol, time)`）

### 10.2 唯一索引

**唯一索引用途**：
- **唯一性约束**：确保字段值唯一
- **查询优化**：唯一索引查询性能好
- **示例**：`config_key`字段的唯一索引

### 10.3 普通索引

**普通索引用途**：
- **查询优化**：为常用查询字段创建索引
- **单字段索引**：如`symbol`、`time`字段索引
- **查询场景**：按币种查询、按时间范围查询

### 10.4 复合索引

**复合索引设计**：
- **字段顺序**：将选择性高的字段放在前面
- **常用组合**：`(symbol, time DESC)`（按币种和时间范围查询）
- **覆盖索引**：包含查询所需的所有字段，避免回表

**复合索引示例**：
- `idx_klines_15m_symbol_time`：`(symbol, time DESC)`
- `idx_signals_status_time`：`(status, detected_at DESC)`

### 10.5 索引优化策略

**优化策略**：
- **选择性高的字段**：优先为选择性高的字段创建索引
- **查询频率**：为高频查询字段创建索引
- **索引数量**：避免过多索引，影响写入性能
- **条件索引**：使用`WHERE`条件创建部分索引（如`fill_time IS NOT NULL`）

## 十一、数据一致性

### 11.1 事务管理

**11.1.1 自动提交**：
- **默认行为**：不自动提交，需要手动调用`session.commit()`
- **优势**：支持事务回滚，保证数据一致性

**11.1.2 手动提交**：
```python
with db.get_session() as session:
    session.execute(sql, params)
    session.commit()  # 手动提交
```

**11.1.3 异常回滚**：
```python
try:
    with db.get_session() as session:
        session.execute(sql, params)
        session.commit()
except Exception as e:
    session.rollback()  # 自动回滚
    raise
```

### 11.2 数据去重

**11.2.1 主键去重**：
- **方式**：使用主键或唯一索引防止重复插入
- **示例**：`ON CONFLICT (symbol, time) DO NOTHING`

**11.2.2 唯一索引去重**：
- **方式**：使用唯一索引确保字段值唯一
- **示例**：`config_key`字段的唯一索引

**11.2.3 应用层去重**：
- **方式**：在插入前查询是否存在
- **场景**：复杂去重逻辑，无法用数据库约束实现

### 11.3 数据完整性

**11.3.1 外键约束**：
- **定义方式**：使用`ForeignKey`定义外键
- **示例**：`snapshot_id`外键关联`market_detection_snapshots.id`
- **注意**：外键约束可能影响性能，根据实际情况决定是否使用

**11.3.2 检查约束**：
- **定义方式**：使用`CHECK`约束
- **示例**：`CHECK (confidence_score >= 0 AND confidence_score <= 100)`

**11.3.3 非空约束**：
- **定义方式**：使用`NOT NULL`约束
- **示例**：`symbol VARCHAR(20) NOT NULL`

## 十二、数据迁移

### 12.1 Alembic迁移工具

**Alembic简介**：
- **用途**：数据库版本控制和迁移管理
- **优势**：支持版本回滚、迁移脚本管理
- **当前状态**：项目暂未使用Alembic，使用SQL脚本直接创建表

### 12.2 迁移脚本

**迁移脚本位置**：
- **SQL脚本**：`database/all_tables.sql`
- **执行方式**：直接执行SQL脚本创建所有表
- **版本管理**：通过Git管理SQL脚本版本

### 12.3 版本管理

**版本管理方式**：
- **Git管理**：SQL脚本通过Git进行版本控制
- **变更记录**：在SQL脚本中记录变更说明
- **回滚方式**：通过Git回滚到之前的SQL脚本版本

## 十三、性能优化

### 13.1 查询优化

**13.1.1 索引使用**：
- **索引选择**：为常用查询字段创建索引
- **索引分析**：使用`EXPLAIN`分析查询计划
- **索引维护**：定期分析索引使用情况，删除无用索引

**13.1.2 查询计划分析**：
- **工具**：使用PostgreSQL的`EXPLAIN ANALYZE`
- **分析内容**：索引使用情况、扫描行数、执行时间
- **优化目标**：减少全表扫描，提高索引使用率

### 13.2 批量操作优化

**13.2.1 批量插入**：
- **方式**：使用`INSERT ... VALUES (...), (...), (...)`批量插入
- **批量大小**：建议每次批量插入100-1000条
- **性能提升**：相比单条插入，性能提升10-100倍

**13.2.2 批量更新**：
- **方式**：使用`UPDATE ... WHERE ... IN (...)`批量更新
- **限制**：IN子句中的值数量建议不超过1000个
- **替代方案**：使用临时表进行批量更新

### 13.3 连接池优化

**连接池配置**：
- **pool_size**：10（连接池大小）
- **max_overflow**：20（最大溢出连接数）
- **pool_pre_ping**：True（连接前检查，自动重连失效连接）
- **pool_recycle**：3600（1小时回收连接）

### 13.4 数据分区（未来考虑）

**分区策略**：
- **时间分区**：按时间范围分区（如按月分区）
- **范围分区**：适用于时序数据表（K线、订单历史等）
- **优势**：提高查询性能，便于数据归档

## 十四、备份和恢复

### 14.1 备份策略

**备份方式**：
- **全量备份**：定期全量备份（如每天一次）
- **增量备份**：定期增量备份（如每小时一次）
- **备份工具**：使用`pg_dump`或`pg_basebackup`

**备份频率**：
- **生产环境**：每天全量备份，每小时增量备份
- **测试环境**：每周全量备份

### 14.2 恢复流程

**恢复步骤**：
1. 停止应用服务
2. 恢复数据库（使用`pg_restore`）
3. 验证数据完整性
4. 启动应用服务

### 14.3 数据导出

**导出方式**：
- **SQL导出**：使用`pg_dump`导出SQL格式
- **CSV导出**：使用`COPY`命令导出CSV格式
- **JSON导出**：使用应用层代码导出JSON格式

## 十五、监控和维护

### 15.1 数据库监控

**监控指标**：
- **连接数**：当前连接数、最大连接数
- **查询性能**：慢查询、查询时间分布
- **表大小**：表大小、索引大小
- **锁等待**：锁等待时间、死锁情况

### 15.2 性能监控

**性能指标**：
- **查询时间**：平均查询时间、P95查询时间
- **TPS**：每秒事务数
- **IO性能**：磁盘IO、缓存命中率
- **CPU使用率**：数据库CPU使用率

### 15.3 日志记录

**日志内容**：
- **操作日志**：所有数据库操作的详细日志
- **错误日志**：数据库错误的详细日志
- **慢查询日志**：记录执行时间超过阈值的查询

### 15.4 定期维护

**维护任务**：
- **VACUUM**：定期执行VACUUM清理死元组
- **ANALYZE**：定期执行ANALYZE更新统计信息
- **索引重建**：定期重建索引，优化查询性能
- **数据归档**：定期归档历史数据，释放存储空间
