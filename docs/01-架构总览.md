# QwenTradeAI 系统架构总览

## 一、系统概述

QwenTradeAI 是一个低频量化交易系统，主要负责市场数据同步、市场信号检测和交易执行。

**核心功能**：
- 多币种市场数据同步（K线、资金费率、未平仓合约等）
- 市场信号自动检测
- 交易订单管理
- WebSocket实时数据订阅

**技术栈**：
- FastAPI（Web框架）
- PostgreSQL（数据库）
- CCXT（交易所API）
- WebSocket（实时数据）

## 二、架构分层

```
┌─────────────────────────────────────────────────────────┐
│                    API层 (FastAPI)                       │
│  - 测试接口路由                                          │
│  - 健康检查                                              │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                  交易层 (Trading)                        │
│  - TradingManager: 交易执行                              │
│  - PendingOrderManager: 挂单管理                         │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                市场检测层 (Layers)                        │
│  - MarketDetector: 市场信号检测                          │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│              数据同步层 (Components)                      │
│  - K线同步、资金费率、未平仓合约等                        │
│  - WebSocket客户端                                       │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│              基础设施层 (Infrastructure)                   │
│  - APIManager: API请求管理（限流、重试）                 │
│  - CoinGlassClient: CoinGlass API客户端                  │
│  - ConfigManager: 配置管理                               │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                数据库层 (Database)                        │
│  - Repository模式                                        │
│  - 数据模型定义                                          │
└─────────────────────────────────────────────────────────┘
```

## 三、核心模块

### 3.1 数据同步模块 (`app/components/`)

**职责**：从外部数据源同步市场数据到数据库

| 模块 | 数据源 | 同步频率 | 线程模型 | 历史补全 | 说明 |
|------|--------|----------|----------|----------|------|
| KlineSyncManager | OKX API | 15m/4h/1d实时 | 每币种1线程 | 支持 | K线数据+技术指标计算 |
| FundingRateSyncManager | OKX API | 每8小时 | 每币种1线程 | 支持 | 资金费率（每8小时一次） |
| OpenInterestSyncManager | CoinGlass | 每15分钟 | 每币种1线程 | 支持 | 未平仓合约 |
| MarketSentimentSyncManager | CoinGlass | 每小时 | 每币种1线程 | 支持 | 市场情绪 |
| OrderBookSyncManager | OKX API | 每小时 | 每币种1线程 | 不支持 | 盘口挂单分布 |
| ETFFlowSyncManager | CoinGlass | 每天8点 | 每币种1线程 | 支持 | ETF资金流（仅BTC/ETH） |
| FearGreedSyncManager | CoinGlass | 每天 | 全局1线程 | 支持 | 恐惧贪婪指数（全局唯一） |
| LiquidationSyncManager | CoinGlass | 每小时 | 每币种1线程 | 支持 | 爆仓历史 |
| OrderHistorySyncManager | OKX API | 每30秒+历史补全 | 全局1线程 | 支持 | 订单历史（所有币种） |
| PositionHistorySyncManager | OKX API | 每30秒+历史补全 | 全局1线程 | 支持 | 仓位历史（所有币种） |

**实现细节**：

**KlineSyncManager**：
- **同步策略**：
  - 15分钟K线：每15分钟同步一次（K线收盘后）
  - 4小时K线：每4小时同步一次（K线收盘后）
  - 日线：每天同步一次
- **历史补全**：
  - 启动时自动补全：15m(30天)、4h(180天)、1d(600天)
  - 支持断点续传：检测时间序列断点，自动补全缺失数据
  - 批量获取：每次最多100根K线，避免API限流
- **技术指标计算**：
  - 同步时自动计算：EMA(9,21,55)、RSI(7)、MACD(8,17,9)、布林带(20,2)、ATR(14)、OBV、ADX(14)
  - 使用IndicatorCalculator统一计算
- **市场检测触发**：
  - 15分钟K线更新时，如果配置了MarketDetector，自动触发检测
- **错误处理**：
  - 网络异常：自动重试（通过APIManager）
  - 数据异常：记录日志，跳过当前K线，继续同步
  - 异常后等待10秒再继续循环

**FundingRateSyncManager**：
- **同步策略**：每8小时同步一次（资金费率结算时间：00:00、08:00、16:00 UTC）
- **历史补全**：启动时补全30天历史数据
- **数据格式**：资金费率、结算时间、下一结算时间

**OpenInterestSyncManager**：
- **同步策略**：每15分钟同步一次
- **历史补全**：启动时补全历史数据
- **数据来源**：CoinGlass API

**OrderHistorySyncManager**：
- **同步策略**：
  - 实时同步：每30秒同步一次所有币种的订单
  - 历史补全：启动时检查缺失订单，自动补全
  - 与WebSocket协调：检查WebSocket状态，避免重复同步
- **去重机制**：基于订单ID去重，避免重复插入
- **错误处理**：单币种失败不影响其他币种

**PositionHistorySyncManager**：
- **同步策略**：
  - 实时同步：每30秒同步一次所有币种的仓位
  - 历史补全：启动时检查缺失仓位，自动补全
- **数据格式**：仓位大小、持仓方向、盈亏、更新时间

**通用特性**：
- **线程安全**：每个同步管理器独立线程，使用threading.Event控制停止
- **优雅关闭**：shutdown时等待线程完成（最多5秒超时）
- **错误隔离**：单个同步任务失败不影响其他任务
- **限流保护**：通过APIManager统一限流，避免API限流

### 3.2 市场检测模块 (`app/layers/market_detector.py`)

**职责**：基于技术指标自动识别交易机会

**三层过滤机制**：

**1. 环境层（Filter Layer）**：
- **市场模式判断**：
  - BULL：价格 > EMA55（牛市）
  - BEAR：价格 < EMA55（熊市）
  - NEUTRAL：价格 ≈ EMA55（震荡）
- **市场活跃度判断**：
  - 基于布林带宽度：当前宽度 >= 平均宽度 × 阈值（默认0.5）
  - 宽度小表示市场不活跃（震荡市），不生成信号
- **多时间框架对齐**：
  - 15m趋势：价格 vs EMA55
  - 4h趋势：价格 vs EMA21
  - 对齐：15m和4h趋势一致时加分
- **输出**：market_mode, market_active, trend_15m, trend_4h, multi_tf_aligned

**2. 触发层（Trigger Layer）**：
- **MACD动量转折检测**：
  - 牛市：MACD柱从负转正，或持续增大
  - 熊市：MACD柱从正转负，或持续减小
- **RSI超买超卖检测**：
  - 做多：RSI < 上限（默认80），防止极端过热
  - 做空：RSI > 下限（默认20），防止极端超卖
- **仓位倍数调整**：
  - 做多：RSI < 50时加倍仓位（更好的盈亏比）
  - 做空：RSI > 50时加倍仓位（更好的盈亏比）
- **输出**：signal_type (LONG/SHORT), rsi_value, macd_histogram

**3. 确认层（Confirm Layer）**：
- **成交量确认**：
  - 当前成交量 >= 平均值 + 倍数 × 标准差（默认1.5倍）
  - 确保有足够的市场参与度
- **布林带确认**：
  - 当前布林带宽度 >= 平均宽度 × 倍数（默认1.2倍）
  - 确保市场波动足够大
- **多时间框架共振**：
  - 15m和4h同时触发信号时加分（可选，默认启用）
- **输出**：confirmed (bool), volume_score, bb_score, multi_tf_score

**检测流程**：
```
1. 获取K线数据（15m×100根，4h×60根）
2. 环境层过滤 → 判断市场环境
3. 如果市场不活跃 → 直接返回，不生成信号
4. 触发层检测 → 识别交易信号
5. 确认层验证 → 验证信号质量
6. 计算综合评分 → 生成最终信号
7. 保存到market_signal表
```

**信号评分机制**：
- **基础分**：环境层通过 +10分
- **触发分**：MACD转折 +5分，RSI符合条件 +3分
- **确认分**：成交量确认 +5分，布林带确认 +3分，多时间框架共振 +4分
- **总分范围**：0-30分
- **信号生成条件**：总分 >= 15分

**信号有效期**：
- 默认4小时（可配置：DETECTOR_SIGNAL_EXPIRE_HOURS）
- 过期信号自动失效，不参与交易

**输入数据**：
- 15分钟K线：100根（可配置：DETECTOR_KLINE_15M_COUNT）
- 4小时K线：60根（可配置：DETECTOR_KLINE_4H_COUNT）
- 技术指标：RSI、MACD、EMA、布林带、OBV、ADX

**输出数据**：
- 市场信号（market_signal表）：
  - signal_type: LONG/SHORT
  - symbol: 币种
  - score: 信号评分（0-30）
  - expire_at: 过期时间
  - details: JSON格式的详细信息

### 3.3 交易模块 (`app/trading/`)

**TradingManager** (`app/trading/trading_manager.py`)：

**核心功能**：

1. **开仓（open_position）**：
   - 参数：symbol, side (LONG/SHORT), amount, stop_loss, take_profit, leverage
   - 流程：
     - 验证参数（价格、数量、止损止盈）
     - 检查是否已有持仓（同一币种只能有一个持仓）
     - 计算实际下单数量（考虑杠杆）
     - 提交市价单或限价单
     - 创建止损止盈条件单（OKX Algo Order）
     - 记录到trading_relations表
   - 返回：订单ID、clOrdId（客户端订单ID）

2. **加仓（add_position）**：
   - 参数：amount, stop_loss, take_profit
   - 流程：
     - 检查当前持仓
     - 验证加仓数量
     - 更新止损止盈
     - 提交加仓订单
     - 更新trading_relations记录

3. **减仓（reduce_position）**：
   - 参数：amount
   - 流程：
     - 检查当前持仓
     - 验证减仓数量（不能超过当前持仓）
     - 提交减仓订单
     - 更新trading_relations记录

4. **平仓（close_position）**：
   - 参数：reason（平仓原因）
   - 流程：
     - 检查当前持仓
     - 取消所有条件单（止损止盈）
     - 提交平仓订单
     - 更新trading_relations记录（标记为已平仓）
     - 计算盈亏

5. **止损止盈管理（set_stop_loss_take_profit）**：
   - 参数：stop_loss, take_profit
   - 流程：
     - 取消旧的止损止盈条件单
     - 创建新的止损止盈条件单
     - 更新trading_relations记录

6. **外部平仓处理（handle_external_close_position）**：
   - 处理WebSocket检测到的外部平仓
   - 自动取消条件单
   - 更新交易记录

**订单管理**：
- **clOrdId生成**：使用ClOrdIdGenerator生成唯一订单ID
- **订单状态追踪**：通过WebSocket实时更新订单状态
- **订单历史记录**：所有订单保存到order_history表

**仓位管理**：
- **当前持仓追踪**：通过trading_relations表追踪
- **持仓方向**：LONG（做多）或SHORT（做空）
- **持仓数量**：实时更新，支持部分平仓

**错误处理**：
- API调用失败：自动重试（通过APIManager）
- 参数验证失败：抛出ValueError
- 持仓状态不一致：记录警告，尝试修复

**PendingOrderManager** (`app/trading/pending_order_manager.py`)：

**核心功能**：

1. **创建挂单（create_pending_order）**：
   - 参数：symbol, side, amount, trigger_price, stop_loss_trigger, take_profit_trigger, leverage, signal_id, expire_hours
   - 流程：
     - 验证参数
     - 取消旧的待处理挂单
     - 创建新挂单记录到pending_order表
   - 返回：挂单ID

2. **查询挂单（get_pending_order）**：
   - 根据挂单ID查询
   - 返回挂单详情（状态、触发价格等）

3. **取消挂单（cancel_pending_order）**：
   - 标记挂单为已取消
   - 不实际取消交易所订单（挂单未触发时）

4. **挂单监控（通过PendingOrderMonitor）**：
   - 定期检查挂单是否触发
   - 检查挂单是否过期
   - 触发时自动执行开仓

**挂单状态**：
- PENDING：待触发
- TRIGGERED：已触发
- CANCELLED：已取消
- EXPIRED：已过期

**挂单过期机制**：
- 默认过期时间：1小时（可配置：PENDING_ORDER_EXPIRE_HOURS）
- 过期后自动标记为EXPIRED，不再触发

### 3.4 WebSocket模块 (`app/components/okx_*_websocket_client.py`)

**OKXOrderWebSocketClient** (`app/components/okx_order_websocket_client.py`)：

**功能**：订阅OKX私有频道，实时接收持仓和订单状态更新

**订阅频道**：
- `positions`: 持仓频道（实时持仓变化）
- `orders`: 订单频道（实时订单状态）

**连接流程**：
1. 建立WebSocket连接
2. 登录认证（使用API密钥签名）
3. 订阅频道
4. 启动心跳机制
5. 开始接收消息

**消息处理**：
- **持仓消息**：
  - 检测持仓变化（开仓、平仓、加仓、减仓）
  - 检测外部平仓（持仓数量变为0）
  - 异步处理平仓事件（通过队列，避免阻塞）
- **订单消息**：
  - 更新订单状态（pending → filled/cancelled）
  - 触发TradingManager回调

**心跳机制**：
- 心跳间隔：20秒（可配置：WS_HEARTBEAT_INTERVAL）
- 发送ping：N秒内未收到消息则发送ping
- ping超时：5秒（可配置：WS_PING_TIMEOUT），超时则重连

**重连机制**：
- 连接断开：自动重连
- 重连间隔：5秒（可配置：WS_RECONNECT_INTERVAL）
- 重连次数：无限制
- 重连时恢复订阅

**去重机制**：
- 持仓消息：基于(pos_id, u_time)去重
- 订单消息：基于订单ID去重
- 保留最近30分钟的处理记录

**异步处理**：
- 平仓事件队列：最大100条（避免内存无限增长）
- 持仓数据队列：最大200条
- 独立处理线程：避免阻塞WebSocket消息接收

**错误处理**：
- 连接失败：自动重连
- 认证失败：记录错误，停止重连
- 消息解析失败：记录警告，继续处理下一条

**OKXOrdersWebSocketClient** (`app/components/okx_orders_websocket_client.py`)：

**功能**：订阅OKX订单频道，实时同步订单状态

**订阅频道**：
- `orders`: 订单频道（所有订单状态更新）

**用途**：
- 与OrderHistorySyncManager协调，避免重复同步
- 实时更新订单状态到数据库

**状态管理**：
- connected: 连接状态
- logged_in: 登录状态
- subscribed: 订阅状态
- running: 运行状态

**消息格式**：
- 订单状态：pending, filled, cancelled, partially-filled
- 订单信息：订单ID、数量、价格、成交数量等

### 3.5 基础设施模块

**APIManager** (`app/components/api_manager.py`)：

**职责**：统一管理所有OKX API请求，提供限流、重试、优先级调度

**核心机制**：

1. **优先级队列**：
   - STOP_LOSS (1)：止损订单（最高优先级）
   - TRADE (2)：交易订单
   - QUERY (3)：查询请求（最低优先级）
   - 使用PriorityQueue实现，高优先级请求优先执行

2. **限流机制**：
   - 速率限制：每2秒最多10次请求（可配置：API_RATE_LIMIT, API_RATE_WINDOW）
   - 最小间隔：每次请求间隔至少200ms（可配置：API_MIN_INTERVAL）
   - 实现：使用时间窗口滑动算法，记录最近N次请求时间

3. **重试机制**：
   - 最大重试次数：3次（可配置：API_MAX_RETRIES）
   - 重试条件：网络异常、超时、5xx错误
   - 不重试：4xx错误（客户端错误，如参数错误）

4. **超时控制**：
   - 请求超时：30秒（可配置：API_REQUEST_TIMEOUT）
   - 超时后自动重试

5. **工作线程模型**：
   - 单工作线程：从队列取请求，执行，回调
   - 线程安全：使用Queue保证线程安全
   - 优雅关闭：设置running=False，等待队列处理完成

6. **API封装**：
   - get_balance(): 获取账户余额
   - get_klines(): 获取K线数据
   - create_order(): 创建订单
   - cancel_order(): 取消订单
   - get_order(): 查询订单
   - get_positions(): 获取持仓
   - 所有API调用都通过submit_request()统一调度

**错误处理**：
- 认证错误：记录警告，不记录完整堆栈（避免泄露密钥信息）
- 其他错误：记录完整错误信息
- 回调机制：请求完成后调用callback，传递结果或错误

**CoinGlassClient** (`app/components/coinglass_client.py`)：

**职责**：封装CoinGlass API调用

**功能**：
- 获取未平仓合约数据
- 获取市场情绪数据
- 获取ETF资金流数据
- 获取恐惧贪婪指数
- 获取爆仓历史数据

**请求限流**：
- 基础限流：避免请求过快
- 错误重试：网络异常自动重试

**ConfigManager** (`app/database/config_manager.py`)：

**职责**：从数据库读取配置，提供类型转换

**配置类型**：
- string: 字符串配置
- int: 整数配置
- float: 浮点数配置
- bool: 布尔配置

**配置读取**：
- 从config表读取
- 如果数据库不可用，使用默认值
- 支持动态更新（修改数据库后立即生效）

**配置项**：
- 应用配置：APP_NAME, APP_VERSION, DEBUG
- 交易所配置：EXCHANGE_API_KEY, EXCHANGE_SECRET, EXCHANGE_PASSPHRASE, EXCHANGE_SANDBOX
- 技术指标配置：RSI_15M_PERIOD, MACD_15M_FAST等
- 同步配置：KLINE_15M_START_DAYS等
- API配置：API_RATE_LIMIT, API_RATE_WINDOW等
- WebSocket配置：WS_RECONNECT_INTERVAL等
- 市场检测器配置：DETECTOR_*等

**IndicatorCalculator** (`app/components/indicator_calculator.py`)：

**职责**：计算技术指标

**支持的指标**：
- EMA（指数移动平均线）
- RSI（相对强弱指标）
- MACD（指数平滑异同移动平均线）
- 布林带（Bollinger Bands）
- ATR（平均真实波幅）
- OBV（能量潮指标）
- ADX（平均方向性指数）

**计算方式**：
- 基于pandas和numpy
- 批量计算，提高性能
- 支持增量计算（新K线时只计算最新指标）

## 四、数据流向

### 4.1 数据同步流程

**详细流程**：

```
1. 系统启动
   ↓
2. 初始化同步管理器（每个币种一个线程）
   ↓
3. 启动时历史数据补全
   ├─ 计算需要补全的时间范围
   ├─ 批量获取历史数据（每次最多100条）
   ├─ 保存到数据库
   └─ 检测断点，继续补全
   ↓
4. 主循环（每秒/每分钟检查）
   ├─ 检查是否需要同步（基于时间判断）
   ├─ 调用APIManager/CoinGlassClient获取数据
   │  ├─ 限流检查（每2秒10次）
   │  ├─ 执行API请求
   │  └─ 错误重试（最多3次）
   ├─ 数据处理和验证
   ├─ 保存到数据库（Repository模式）
   └─ 更新同步时间戳
   ↓
5. 异常处理
   ├─ 网络异常：自动重试
   ├─ 数据异常：记录日志，跳过
   └─ 系统异常：等待后继续
```

**K线同步特殊流程**：
```
K线同步管理器
   ↓
获取最新K线（15m/4h/1d）
   ↓
计算技术指标（IndicatorCalculator）
   ├─ EMA(9,21,55)
   ├─ RSI(7)
   ├─ MACD(8,17,9)
   ├─ 布林带(20,2)
   ├─ ATR(14)
   ├─ OBV
   └─ ADX(14)
   ↓
保存到数据库（klines_15m/4h/1d表）
   ↓
如果配置了MarketDetector，触发市场检测
   ↓
MarketDetector检测市场信号
```

### 4.2 市场检测流程

**详细流程**：

```
1. 触发条件
   ├─ K线同步完成（15分钟K线更新）
   └─ 手动调用检测接口
   ↓
2. 获取K线数据
   ├─ 15分钟K线：100根（含技术指标）
   └─ 4小时K线：60根（含技术指标）
   ↓
3. 环境层过滤（_filter_layer）
   ├─ 判断市场模式（BULL/BEAR/NEUTRAL）
   │  └─ 价格 vs EMA55
   ├─ 判断市场活跃度
   │  └─ 布林带宽度 vs 平均宽度
   └─ 判断多时间框架对齐
      └─ 15m趋势 vs 4h趋势
   ↓
4. 如果市场不活跃 → 直接返回，不生成信号
   ↓
5. 触发层检测（_trigger_layer）
   ├─ MACD动量转折检测
   │  ├─ 牛市：MACD柱从负转正或持续增大
   │  └─ 熊市：MACD柱从正转负或持续减小
   ├─ RSI超买超卖检测
   │  ├─ 做多：RSI < 80（防止极端过热）
   │  └─ 做空：RSI > 20（防止极端超卖）
   └─ 仓位倍数调整
      ├─ 做多：RSI < 50时加倍仓位
      └─ 做空：RSI > 50时加倍仓位
   ↓
6. 确认层验证（_confirm_layer）
   ├─ 成交量确认
   │  └─ 当前成交量 >= 平均值 + 1.5×标准差
   ├─ 布林带确认
   │  └─ 当前宽度 >= 平均宽度 × 1.2
   └─ 多时间框架共振（可选）
      └─ 15m和4h同时触发信号
   ↓
7. 计算综合评分
   ├─ 基础分：环境层通过 +10分
   ├─ 触发分：MACD转折 +5分，RSI符合 +3分
   ├─ 确认分：成交量确认 +5分，布林带确认 +3分，多时间框架 +4分
   └─ 总分范围：0-30分
   ↓
8. 如果总分 >= 15分 → 生成信号
   ↓
9. 保存到market_signal表
   ├─ signal_type: LONG/SHORT
   ├─ symbol: 币种
   ├─ score: 信号评分
   ├─ expire_at: 过期时间（当前时间 + 4小时）
   └─ details: JSON格式的详细信息
```

### 4.3 交易执行流程

**开仓流程**：

```
1. 市场信号触发（或手动调用）
   ↓
2. TradingManager.open_position()
   ├─ 参数验证（价格、数量、止损止盈）
   ├─ 检查是否已有持仓（同一币种只能有一个）
   └─ 计算实际下单数量（考虑杠杆）
   ↓
3. 提交开仓订单
   ├─ 通过APIManager提交（优先级：TRADE）
   ├─ 订单类型：市价单或限价单
   └─ 返回订单ID和clOrdId
   ↓
4. 创建止损止盈条件单
   ├─ 通过APIManager创建Algo Order
   ├─ 止损条件单：价格触发时自动平仓
   └─ 止盈条件单：价格触发时自动平仓
   ↓
5. 记录交易关系
   ├─ 保存到trading_relations表
   ├─ 关联开仓订单ID
   └─ 记录止损止盈价格
   ↓
6. WebSocket实时更新
   ├─ 订单状态更新（pending → filled）
   ├─ 持仓状态更新（开仓成功）
   └─ 触发TradingManager回调
   ↓
7. 订单监控
   ├─ PendingOrderManager监控订单状态
   └─ 订单完成后更新trading_relations
```

**平仓流程**：

```
1. 触发平仓（手动/止损/止盈/外部平仓）
   ↓
2. TradingManager.close_position()
   ├─ 检查当前持仓
   ├─ 取消所有条件单（止损止盈）
   └─ 计算平仓数量（全部或部分）
   ↓
3. 提交平仓订单
   ├─ 通过APIManager提交（优先级：TRADE）
   └─ 订单方向：与开仓相反
   ↓
4. 更新交易关系
   ├─ 标记为已平仓
   ├─ 记录平仓订单ID
   ├─ 计算盈亏（pnl, pnl_percentage）
   └─ 记录平仓原因
   ↓
5. WebSocket实时更新
   ├─ 订单状态更新
   ├─ 持仓状态更新（持仓数量变为0）
   └─ 检测到外部平仓时自动处理
```

**外部平仓检测流程**：

```
1. WebSocket接收持仓消息
   ↓
2. 检测持仓变化
   ├─ 持仓数量从 >0 变为 0
   └─ 记录(pos_id, u_time)用于去重
   ↓
3. 异步处理（通过队列）
   ├─ 添加到平仓事件队列
   └─ 独立线程处理，避免阻塞WebSocket
   ↓
4. TradingManager.handle_external_close_position()
   ├─ 查找对应的clOrdId
   ├─ 取消所有条件单
   ├─ 更新trading_relations（标记为已平仓）
   └─ 计算盈亏
```

## 五、模块依赖关系

**依赖图**：

```
main.py (应用入口)
    ├── 初始化所有组件
    ├── 启动数据同步线程
    ├── 启动WebSocket客户端
    └── 注册API路由

数据同步层
    ├── 依赖: APIManager (API请求)
    ├── 依赖: CoinGlassClient (CoinGlass API)
    ├── 依赖: Database (Repository)
    └── 可选: MarketDetector (K线同步时触发检测)

市场检测层
    ├── 依赖: Database (K线数据)
    └── 输出: 市场信号 (market_signal表)

交易层
    ├── 依赖: APIManager (订单提交)
    ├── 依赖: Database (市场信号、订单历史、交易关系)
    └── 依赖: WebSocket (订单状态回调)

WebSocket层
    ├── 依赖: TradingManager (订单回调)
    └── 输出: 订单状态更新、持仓状态更新

基础设施层
    ├── APIManager: 依赖CCXT库、配置
    ├── CoinGlassClient: 依赖HTTP客户端、配置
    └── ConfigManager: 依赖Database
```

**依赖注入**：
- TradingManager → APIManager（通过构造函数注入）
- KlineSyncManager → MarketDetector（可选，通过构造函数注入）
- OKXOrderWebSocketClient → TradingManager（通过构造函数注入）
- 所有组件 → Database（通过全局db实例）

**循环依赖避免**：
- 使用依赖注入，避免循环依赖
- 延迟初始化：部分组件在需要时才初始化
- 接口隔离：组件之间通过接口交互，不直接依赖实现

## 六、数据库设计

### 6.1 核心数据表

**K线数据表**：
- `klines_15m`: 15分钟K线（主键：symbol, time）
  - 基础数据：open, high, low, close, volume
  - 技术指标：ema_9, ema_21, ema_55, rsi_7, macd_line, signal_line, histogram, bb_upper, bb_middle, bb_lower, atr_14, obv, obv_ema_9, adx_14, bb_width
- `klines_4h`: 4小时K线（主键：symbol, time）
  - 基础数据：open, high, low, close, volume
  - 技术指标：ema_9, ema_21, rsi_14, macd_line, signal_line, histogram, bb_upper, bb_middle, bb_lower
- `klines_1d`: 日线K线（主键：symbol, time）
  - 基础数据：open, high, low, close, volume
  - 技术指标：ema_9, ema_21, rsi_14, macd_line, signal_line, histogram

**市场数据表**：
- `funding_rate`: 资金费率（主键：symbol, time）
  - 字段：funding_rate, next_funding_time
- `open_interest`: 未平仓合约（主键：symbol, time）
  - 字段：open_interest, change_24h, change_percent_24h
- `market_sentiment`: 市场情绪（主键：symbol, time）
  - 字段：long_short_ratio, long_account_ratio, short_account_ratio
- `order_book`: 盘口挂单（主键：symbol, time）
  - 字段：bids, asks（JSON格式）
- `etf_flow`: ETF资金流（主键：symbol, date）
  - 字段：net_flow, total_flow_in, total_flow_out
- `fear_greed`: 恐惧贪婪指数（主键：time）
  - 字段：value, classification
- `liquidation`: 爆仓历史（主键：symbol, time）
  - 字段：long_liquidation, short_liquidation, total_liquidation

**交易数据表**：
- `order_history`: 订单历史（主键：order_id）
  - 字段：symbol, side, order_type, amount, price, filled_amount, status, cl_ord_id, created_at, updated_at
- `position_history`: 仓位历史（主键：pos_id, u_time）
  - 字段：symbol, pos_side, pos_size, avg_price, unrealized_pnl, margin, leverage, updated_at
- `market_signal`: 市场信号（主键：id）
  - 字段：symbol, signal_type, score, expire_at, details（JSON）, created_at
- `pending_order`: 挂单记录（主键：id）
  - 字段：symbol, side, amount, trigger_price, stop_loss_trigger, take_profit_trigger, leverage, signal_id, status, expire_at, created_at
- `trading_relations`: 交易关系（主键：id）
  - 字段：symbol, side, open_order_id, close_order_id, open_time, close_time, pnl, pnl_percentage, status

**系统表**：
- `config`: 系统配置（主键：key）
  - 字段：key, value, value_type, description, updated_at
- `system_status`: 系统状态（主键：key）
  - 字段：key, value, updated_at

### 6.2 数据访问层（Repository模式）

**设计模式**：
- 每个数据表对应一个Repository类
- Repository提供静态方法，封装数据库操作
- 使用SQLAlchemy ORM进行数据库操作

**Repository列表**：
- `KlineRepository`: K线数据操作
- `FundingRateRepository`: 资金费率操作
- `OpenInterestRepository`: 未平仓合约操作
- `MarketSentimentRepository`: 市场情绪操作
- `OrderBookRepository`: 盘口挂单操作
- `ETFFlowRepository`: ETF资金流操作
- `FearGreedRepository`: 恐惧贪婪指数操作
- `LiquidationRepository`: 爆仓历史操作
- `OrderHistoryRepository`: 订单历史操作
- `PositionHistoryRepository`: 仓位历史操作
- `MarketSignalRepository`: 市场信号操作
- `PendingOrderRepository`: 挂单记录操作
- `TradingRelationsRepository`: 交易关系操作
- `ConfigManager`: 配置管理

**常用操作**：
- `insert_*`: 插入数据（支持批量插入）
- `get_*`: 查询数据（支持条件查询、排序、分页）
- `get_latest_*`: 获取最新数据
- `update_*`: 更新数据
- `delete_*`: 删除数据

### 6.3 数据库连接管理

**连接池**：
- 使用SQLAlchemy连接池
- 连接池大小：可配置
- 连接超时：可配置

**会话管理**：
- 使用上下文管理器（with语句）
- 自动提交：每个操作自动提交
- 异常回滚：异常时自动回滚

**连接配置**：
- 数据库URL：从环境变量读取
- 格式：postgresql://用户名:密码@主机:端口/数据库名

## 七、启动流程

**详细启动流程**：

```
1. 应用启动（main.py）
   ↓
2. 初始化配置（Settings类）
   ├─ 从环境变量读取数据库连接URL
   ├─ 连接数据库
   ├─ 初始化ConfigManager
   └─ 从config表读取所有配置
   ↓
3. 初始化基础设施
   ├─ APIManager
   │  ├─ 初始化CCXT交易所实例
   │  ├─ 启动工作线程
   │  └─ 初始化限流器
   ├─ CoinGlassClient
   │  └─ 初始化HTTP客户端
   └─ Logger（日志系统）
   ↓
4. 初始化市场检测器
   ├─ 获取交易币种列表（TRADING_SYMBOLS）
   ├─ 为指定币种创建MarketDetector（目前仅ETH）
   └─ 存储到market_detectors字典
   ↓
5. 启动数据同步线程
   ├─ KlineSyncManager（每个币种1个线程）
   │  ├─ 传入MarketDetector（如果存在）
   │  ├─ 启动线程
   │  └─ 开始历史数据补全
   ├─ FundingRateSyncManager（每个币种1个线程）
   ├─ OpenInterestSyncManager（每个币种1个线程）
   ├─ MarketSentimentSyncManager（每个币种1个线程）
   ├─ OrderBookSyncManager（每个币种1个线程）
   ├─ ETFFlowSyncManager（BTC/ETH各1个线程）
   ├─ FearGreedSyncManager（全局1个线程）
   ├─ LiquidationSyncManager（每个币种1个线程）
   ├─ OrderHistorySyncManager（全局1个线程）
   └─ PositionHistorySyncManager（全局1个线程）
   ↓
6. 初始化交易管理器
   ├─ TradingManager
   │  ├─ 依赖注入APIManager
   │  └─ 初始化ClOrdIdGenerator
   └─ PendingOrderManager
      └─ 初始化数据库连接
   ↓
7. 启动WebSocket客户端
   ├─ OKXOrdersWebSocketClient
   │  ├─ 连接WebSocket
   │  ├─ 登录认证
   │  └─ 订阅订单频道
   └─ OKXOrderWebSocketClient
      ├─ 依赖注入TradingManager
      ├─ 连接WebSocket
      ├─ 登录认证
      ├─ 订阅持仓和订单频道
      └─ 启动异步处理线程
   ↓
8. 注册API路由
   ├─ position_history_test（仓位历史测试）
   ├─ trading_test（交易测试）
   └─ pending_order（挂单管理）
   ↓
9. FastAPI应用启动完成
   ├─ 监听端口：8000（可配置）
   ├─ 提供Swagger文档：/docs
   └─ 提供ReDoc文档：/redoc
```

**启动顺序说明**：
- 配置必须在最前面（所有组件依赖配置）
- 基础设施在数据同步之前（数据同步依赖APIManager）
- 市场检测器在K线同步之前（K线同步可能触发检测）
- WebSocket在交易管理器之后（WebSocket依赖TradingManager）
- API路由最后注册（依赖所有组件）

**优雅关闭流程**：

```
1. 接收关闭信号（SIGTERM/SIGINT）
   ↓
2. 停止所有数据同步线程
   ├─ 设置stop_event
   ├─ 等待线程完成（最多5秒超时）
   └─ 记录关闭状态
   ↓
3. 关闭WebSocket客户端
   ├─ 停止消息接收
   ├─ 停止异步处理线程
   └─ 关闭连接
   ↓
4. 关闭API管理器
   ├─ 设置running=False
   ├─ 等待队列处理完成（最多3秒超时）
   └─ 停止工作线程
   ↓
5. 关闭数据库连接
   ↓
6. 应用关闭完成
```

## 八、技术特点

### 8.1 并发模型

**多线程架构**：
- 每个数据同步任务独立线程（threading.Thread）
- 主线程：FastAPI应用（处理HTTP请求）
- 工作线程：APIManager工作线程（处理API请求队列）
- 同步线程：每个同步管理器1个线程（10+个线程）
- WebSocket线程：每个WebSocket客户端1个线程（2个线程）
- 异步处理线程：WebSocket消息异步处理（2个线程）

**线程安全**：
- 使用threading.Event控制线程停止
- 使用Queue实现线程间通信
- 使用Lock保护共享资源（如持仓状态字典）

**线程数量**：
- 假设交易3个币种（BTC、ETH、SOL）：
  - 数据同步线程：3×7 + 1（FearGreed） + 2（Order/Position History） = 24个
  - WebSocket线程：2个
  - API工作线程：1个
  - 异步处理线程：2个
  - 总计：约29个线程

### 8.2 限流和重试机制

**API限流**：
- 速率限制：每2秒最多10次请求（可配置）
- 最小间隔：每次请求间隔至少200ms
- 实现：时间窗口滑动算法

**自动重试**：
- 最大重试次数：3次（可配置）
- 重试条件：网络异常、超时、5xx错误
- 不重试：4xx错误（客户端错误）

**优先级调度**：
- 止损订单：最高优先级（立即执行）
- 交易订单：中等优先级
- 查询请求：最低优先级

### 8.3 数据一致性

**数据库事务**：
- 使用SQLAlchemy Session管理事务
- 自动提交：每个操作自动提交
- 异常回滚：异常时自动回滚

**数据去重**：
- 订单历史：基于订单ID去重
- 持仓历史：基于(pos_id, u_time)去重
- WebSocket消息：基于消息ID去重

**断点续传**：
- K线同步：检测时间序列断点，自动补全
- 订单历史：记录最后同步时间，从断点继续
- 仓位历史：记录最后同步时间，从断点继续

### 8.4 错误处理和恢复

**错误分类**：
- 网络错误：自动重试
- 数据错误：记录日志，跳过当前数据
- 系统错误：记录日志，等待后继续
- 认证错误：记录警告，停止相关操作

**错误恢复**：
- 自动重试：网络异常自动重试
- 优雅降级：部分功能失败不影响其他功能
- 状态恢复：重启后自动恢复同步状态

### 8.5 配置管理

**配置来源**：
- 数据库（config表）：主要配置源
- 环境变量：数据库连接URL
- 默认值：数据库不可用时使用

**配置类型**：
- 字符串：API密钥、URL等
- 整数：周期、数量等
- 浮点数：价格、阈值等
- 布尔值：开关、标志等

**动态配置**：
- 配置修改后立即生效（无需重启）
- 通过ConfigManager统一读取

### 8.6 性能优化

**批量处理**：
- K线历史补全：每次最多100根
- 订单历史同步：批量查询
- 数据库插入：批量插入（使用ON CONFLICT）

**异步处理**：
- WebSocket消息：异步队列处理
- 平仓事件：异步处理，避免阻塞
- API回调：异步回调机制

**缓存机制**：
- 配置缓存：ConfigManager缓存配置值
- 持仓状态缓存：WebSocket客户端缓存持仓状态

### 8.7 监控和日志

**日志系统**：
- 日志级别：DEBUG、INFO、WARNING、ERROR、CRITICAL
- 日志文件：logs/qwentradeai.log
- 日志轮转：单个文件最大10MB，保留5个备份
- 日志格式：时间、级别、模块、消息

**监控指标**：
- 同步状态：每个同步任务的最后同步时间
- 订单状态：订单执行状态和耗时
- WebSocket状态：连接状态、消息接收频率
- API状态：请求成功率、限流情况

### 8.8 安全性

**API密钥管理**：
- 密钥存储在数据库（加密存储建议）
- 不在日志中记录完整密钥
- 认证错误只记录警告，不记录堆栈

**数据验证**：
- 参数验证：所有输入参数严格验证
- 数据格式验证：API返回数据格式验证
- 边界检查：数量、价格等边界检查

**错误信息**：
- 不泄露敏感信息（如API密钥）
- 错误信息详细但不暴露内部实现

## 九、API接口说明

### 9.1 交易接口 (`/trading`)

**开仓接口**：`POST /trading/open-position`
- 功能：开仓（做多/做空）
- 参数：symbol, side (LONG/SHORT), amount, stop_loss_trigger, take_profit_trigger, leverage, signal_id
- 返回：cl_ord_id（客户端订单ID）

**设置止损止盈**：`POST /trading/set-stop-loss-take-profit`
- 功能：设置止损止盈（支持多个）
- 参数：cl_ord_id, plans (列表，每个元素包含take_profit/stop_loss和amount)
- 返回：成功/失败

**加仓接口**：`POST /trading/add-position`
- 功能：加仓
- 参数：cl_ord_id, amount
- 返回：成功/失败

**减仓接口**：`POST /trading/reduce-position`
- 功能：减仓
- 参数：cl_ord_id, amount
- 返回：成功/失败

**平仓接口**：`POST /trading/close-position`
- 功能：平仓（全部或部分）
- 参数：cl_ord_id, amount (可选，None表示全部平仓)
- 返回：成功/失败

**查询订单状态**：`GET /trading/order-status/{cl_ord_id}`
- 功能：查询订单状态
- 返回：订单详情（状态、数量、价格等）

**查询当前持仓**：`GET /trading/current-position`
- 功能：查询当前持仓
- 返回：持仓详情（方向、数量、盈亏等）

### 9.2 挂单接口 (`/pending-order`)

**创建挂单**：`POST /pending-order/create`
- 功能：创建挂单（价格触发时自动开仓）
- 参数：symbol, side, amount, trigger_price, stop_loss_trigger, take_profit_trigger, leverage, signal_id, expire_hours
- 返回：挂单ID

**查询挂单**：`GET /pending-order/{order_id}`
- 功能：查询挂单详情
- 返回：挂单详情（状态、触发价格等）

**查询挂单列表**：`GET /pending-order/status/{status}`
- 功能：按状态查询挂单列表
- 参数：status (PENDING/TRIGGERED/CANCELLED/EXPIRED)
- 返回：挂单列表

**取消挂单**：`POST /pending-order/{order_id}/cancel`
- 功能：取消挂单
- 返回：成功/失败

### 9.3 订单历史接口 (`/order-history`)

**查询同步状态**：`GET /order-history/status`
- 功能：查询订单历史同步状态
- 返回：同步状态、最后同步时间等

**查询订单列表**：`GET /order-history/orders`
- 功能：查询订单列表
- 参数：symbol (可选), status (可选), limit, offset
- 返回：订单列表

**查询订单详情**：`GET /order-history/orders/{ord_id}`
- 功能：查询订单详情
- 返回：订单详情

**查询币种统计**：`GET /order-history/symbols/{symbol}/stats`
- 功能：查询币种订单统计
- 返回：订单数量、成交金额、盈亏等

### 9.4 仓位历史接口 (`/position-history`)

**查询同步状态**：`GET /position-history/status`
- 功能：查询仓位历史同步状态
- 返回：同步状态、最后同步时间等

**查询仓位列表**：`GET /position-history/positions`
- 功能：查询仓位列表
- 参数：symbol (可选), limit, offset
- 返回：仓位列表

**查询仓位详情**：`GET /position-history/positions/{pos_id}`
- 功能：查询仓位详情
- 返回：仓位详情

**查询币种统计**：`GET /position-history/symbols/{symbol}/stats`
- 功能：查询币种仓位统计
- 返回：仓位数量、总盈亏等

### 9.5 市场检测接口 (`/market-detector`)

**触发检测**：`POST /market-detector/detect`
- 功能：手动触发市场检测
- 参数：symbol
- 返回：检测结果（信号类型、评分等）

**查询检测状态**：`GET /market-detector/status`
- 功能：查询市场检测器状态
- 返回：检测器状态、最后检测时间等

### 9.6 系统接口

**健康检查**：`GET /health`
- 功能：系统健康检查
- 返回：系统状态

**数据库测试**：`GET /database/test`
- 功能：测试数据库连接
- 返回：连接状态

**查询数据表**：`GET /database/tables`
- 功能：查询所有数据表
- 返回：数据表列表

### 9.7 API文档

**Swagger UI**：`/docs`
- 功能：交互式API文档
- 支持：在线测试API接口

**ReDoc**：`/redoc`
- 功能：API文档（ReDoc格式）
- 支持：更美观的文档展示

**OpenAPI JSON**：`/openapi.json`
- 功能：OpenAPI规范JSON
- 支持：API客户端代码生成

