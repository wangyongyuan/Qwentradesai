# QwenTradeAI 项目架构总览

## 一、项目概述

### 1.1 项目定位

QwenTradeAI 是一个**加密货币市场数据同步系统**，专注于实时收集、存储和管理加密货币市场的各类数据，为后续的数据分析和决策提供可靠的数据基础。

### 1.2 核心功能

- **K线数据同步**：实时同步15分钟、4小时、日线K线数据，并自动计算技术指标
- **市场数据同步**：同步资金费率、未平仓合约、市场情绪、盘口挂单、ETF资金流、恐惧贪婪指数等
- **数据存储**：使用 PostgreSQL + TimescaleDB 存储时序数据，支持数据压缩和自动清理
- **配置管理**：所有配置项存储在数据库中，支持动态配置更新
- **API服务**：提供 FastAPI Web 服务，支持数据查询和系统监控

### 1.3 技术特点

- **纯数据同步**：系统专注于数据收集和存储，不包含AI分析和交易执行功能
- **多币种支持**：支持同时同步多个币种的数据（BTC、ETH等）
- **高可用性**：使用独立线程进行数据同步，互不干扰
- **可扩展性**：模块化设计，易于添加新的数据源和同步任务

---

## 二、系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                      FastAPI Web 服务                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  API Routes  │  │  Health API  │  │  Test API    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    数据同步管理层                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ K线同步      │  │ 资金费率同步  │  │ 未平仓合约同步│      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ 市场情绪同步 │  │ 盘口挂单同步  │  │ ETF资金流同步│      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│  ┌──────────────┐                                          │
│  │ 恐惧贪婪指数 │                                          │
│  └──────────────┘                                          │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    数据访问层                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ API Manager  │  │ CoinGlass    │  │ 指标计算器   │      │
│  │ (OKX API)    │  │ Client       │  │              │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    数据存储层                                │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  PostgreSQL + TimescaleDB                            │  │
│  │  - K线数据表 (15m, 4h, 1d)                           │  │
│  │  - 市场数据表 (资金费率、未平仓、情绪等)              │  │
│  │  - 系统配置表                                         │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 架构层次说明

#### 第一层：Web服务层
- **FastAPI应用**：提供HTTP API服务
- **路由模块**：处理API请求，提供数据查询和测试接口
- **文档服务**：自动生成Swagger/ReDoc API文档

#### 第二层：数据同步管理层
- **同步管理器**：每个数据源对应一个独立的同步管理器
- **线程管理**：使用Python threading实现并发同步
- **调度控制**：根据数据更新频率自动调度同步任务

#### 第三层：数据访问层
- **API管理器**：封装交易所API调用，实现请求限流和重试
- **第三方客户端**：封装CoinGlass API调用
- **指标计算器**：计算技术指标（RSI、MACD、EMA等）

#### 第四层：数据存储层
- **PostgreSQL**：关系型数据库，存储结构化数据
- **TimescaleDB**：时序数据库扩展，优化时序数据存储和查询
- **数据仓库**：Repository模式封装数据库操作

---

## 三、技术栈

### 3.1 后端框架

- **FastAPI 0.104.1**：现代Python Web框架，支持异步处理
- **Uvicorn**：ASGI服务器，支持高并发

### 3.2 数据库

- **PostgreSQL 14+**：主数据库
- **TimescaleDB 2.13+**：时序数据库扩展
- **SQLAlchemy 2.0**：ORM框架
- **psycopg2-binary**：PostgreSQL驱动

### 3.3 数据源API

- **CCXT 4.0+**：加密货币交易所统一API库（OKX）
- **CoinGlass API**：市场情绪、未平仓合约等数据
- **Requests/HTTPX**：HTTP客户端

### 3.4 数据处理

- **Pandas 2.0+**：数据处理和分析
- **NumPy 1.24+**：数值计算

### 3.5 配置管理

- **Pydantic 2.5**：数据验证和配置管理
- **python-dotenv**：环境变量管理

### 3.6 日志

- **Python logging**：标准日志库
- **RotatingFileHandler**：日志轮转

---

## 四、项目目录结构

```
QwenTradeAI/
├── app/                          # 应用主目录
│   ├── __init__.py
│   ├── main.py                   # FastAPI应用入口
│   ├── config.py                 # 配置管理（从数据库读取）
│   │
│   ├── api/                      # API路由
│   │   ├── __init__.py
│   │   └── routes/               # 路由模块
│   │       ├── api_test.py       # API测试路由
│   │       ├── kline_test.py     # K线数据测试路由
│   │       ├── coinglass_test.py # CoinGlass数据测试路由
│   │       ├── database.py       # 数据库测试路由
│   │       └── health.py         # 健康检查路由
│   │
│   ├── components/               # 核心组件
│   │   ├── api_manager.py       # API管理器（限流、重试）
│   │   ├── coinglass_client.py  # CoinGlass API客户端
│   │   ├── indicator_calculator.py # 技术指标计算器
│   │   ├── kline_sync.py        # K线数据同步管理器
│   │   ├── funding_rate_sync.py # 资金费率同步管理器
│   │   ├── open_interest_sync.py # 未平仓合约同步管理器
│   │   ├── market_sentiment_sync.py # 市场情绪同步管理器
│   │   ├── order_book_sync.py   # 盘口挂单同步管理器
│   │   ├── etf_flow_sync.py      # ETF资金流同步管理器
│   │   └── fear_greed_sync.py   # 恐惧贪婪指数同步管理器
│   │
│   ├── database/                # 数据库层
│   │   ├── connection.py        # 数据库连接管理
│   │   ├── config_manager.py    # 配置管理器（从数据库读取配置）
│   │   ├── klines.py            # K线数据仓库
│   │   ├── funding_rate.py      # 资金费率数据仓库
│   │   ├── open_interest.py     # 未平仓合约数据仓库
│   │   ├── market_sentiment.py  # 市场情绪数据仓库
│   │   ├── order_book.py        # 盘口挂单数据仓库
│   │   ├── etf_flow.py          # ETF资金流数据仓库
│   │   ├── fear_greed.py        # 恐惧贪婪指数数据仓库
│   │   └── models.py            # 数据模型定义
│   │
│   └── utils/                   # 工具模块
│       └── logger.py            # 日志工具
│
├── database/                     # 数据库脚本
│   └── all_tables.sql           # 所有数据表定义（包含TimescaleDB配置）
│
├── docs/                         # 项目文档
│   ├── 00-项目架构总览.md        # 本文档
│   ├── 01-数据库设计模块.md      # 数据库设计文档
│   ├── 02-指标计算模块.md        # 技术指标计算文档
│   ├── 03-K线数据同步模块.md     # K线同步文档
│   └── 04-其他数据源同步模块.md  # 其他数据源同步文档
│
├── requirements.txt              # Python依赖
├── package.sh                    # 项目打包脚本
└── .env                          # 环境变量配置（不包含在打包中）
```

---

## 五、核心模块说明

### 5.1 配置管理模块 (`app/config.py`)

**功能**：从数据库读取所有配置项，替代传统的环境变量配置

**特点**：
- 启动时从环境变量读取 `DATABASE_URL`（用于连接数据库）
- 连接数据库后，从 `system_config` 表加载所有配置
- 如果数据库不可用，使用默认值
- 所有配置项通过 `@property` 装饰器访问，支持类型转换

**配置项分类**：
- 应用基础配置（APP_NAME、APP_VERSION、DEBUG等）
- 数据库配置（DATABASE_URL）
- 交易所配置（EXCHANGE_NAME、API_KEY等）
- 技术指标配置（RSI、MACD、EMA等参数）
- API管理器配置（限流、超时等）
- WebSocket配置
- 日志配置

### 5.2 数据同步管理器

所有同步管理器都采用统一的设计模式：

```python
class XxxSyncManager(threading.Thread):
    """数据同步管理器（后台线程）"""
    
    def __init__(self, ...):
        # 初始化参数
        self.stop_event = threading.Event()
    
    def run(self):
        # 主循环：定时检查并同步数据
        while not self.stop_event.is_set():
            if self._should_sync():
                self._fetch_and_save_data()
            time.sleep(check_interval)
    
    def stop(self):
        # 停止同步线程
        self.stop_event.set()
```

**同步管理器列表**：
- `KlineSyncManager`：K线数据同步（15m、4h、1d）
- `FundingRateSyncManager`：资金费率同步（每8小时）
- `OpenInterestSyncManager`：未平仓合约同步（每15分钟）
- `MarketSentimentSyncManager`：市场情绪同步（每4小时）
- `OrderBookSyncManager`：盘口挂单同步（每1小时）
- `ETFFlowSyncManager`：ETF资金流同步（每天）
- `FearGreedSyncManager`：恐惧贪婪指数同步（每天）

---

---

## 六、数据流设计

### 6.1 K线数据同步流程

```
┌─────────────┐
│   OKX API   │
└──────┬──────┘
       │ fetch_ohlcv()
       ▼
┌─────────────────┐
│  API Manager    │  ← 请求限流、重试机制
│  (限流队列)     │
└──────┬──────────┘
       │ K线原始数据
       ▼
┌─────────────────┐
│ KlineSyncManager│  ← 检查同步时机
└──────┬──────────┘
       │
       ├─→ 15分钟K线 ──┐
       ├─→ 4小时K线  ──┤
       └─→ 日线K线   ──┤
                       ▼
              ┌─────────────────┐
              │ IndicatorCalculator│ ← 计算技术指标
              └────────┬─────────┘
                       │ 带指标的数据
                       ▼
              ┌─────────────────┐
              │ KlineRepository │ ← 数据验证、去重
              └────────┬─────────┘
                       │
                       ▼
              ┌─────────────────┐
              │ PostgreSQL      │
              │ (TimescaleDB)   │
              └─────────────────┘
```

**关键步骤**：
1. **API调用**：通过 `APIManager` 调用 OKX API，获取K线原始数据
2. **数据验证**：检查数据完整性和时间戳
3. **指标计算**：使用 `IndicatorCalculator` 计算技术指标
4. **数据存储**：通过 `KlineRepository` 保存到数据库（自动去重）

### 6.2 市场数据同步流程

```
┌──────────────┐      ┌──────────────┐
│   OKX API    │      │ CoinGlass API│
└──────┬───────┘      └──────┬───────┘
       │                     │
       ├─ 资金费率            ├─ 未平仓合约
       ├─ 盘口挂单            ├─ 市场情绪
       │                     ├─ ETF资金流
       │                     └─ 恐惧贪婪指数
       │
       ▼                     ▼
┌──────────────┐      ┌──────────────┐
│ API Manager  │      │CoinGlassClient│
└──────┬───────┘      └──────┬───────┘
       │                     │
       └──────────┬──────────┘
                  │
                  ▼
         ┌─────────────────┐
         │ 同步管理器      │  ← 定时检查、自动同步
         │ (各数据源)      │
         └────────┬─────────┘
                  │
                  ▼
         ┌─────────────────┐
         │ 数据仓库        │  ← 数据验证、去重
         │ (Repository)    │
         └────────┬─────────┘
                  │
                  ▼
         ┌─────────────────┐
         │ PostgreSQL      │
         │ (TimescaleDB)   │
         └─────────────────┘
```

### 6.3 配置加载流程

```
应用启动
   │
   ▼
读取 .env 文件
   │
   ├─→ DATABASE_URL (环境变量)
   │
   ▼
连接 PostgreSQL
   │
   ▼
从 system_config 表加载配置
   │
   ├─→ 应用配置 (APP_NAME, DEBUG等)
   ├─→ 交易所配置 (API_KEY, SECRET等)
   ├─→ 技术指标配置 (RSI_PERIOD等)
   ├─→ API配置 (RATE_LIMIT等)
   └─→ 其他配置...
   │
   ▼
缓存到 ConfigManager
   │
   ▼
Settings 类通过 @property 访问
```

---

## 七、核心组件详解

### 7.1 API管理器 (`APIManager`)

**功能**：统一管理交易所API调用，实现请求限流、重试和错误处理

**核心特性**：

1. **请求队列机制**
   ```python
   class APIManager:
       def __init__(self):
           self.request_queue = Queue()  # 请求队列
           self.worker_thread = None     # 工作线程
   ```

2. **优先级队列**
   - `CRITICAL`：关键请求（最高优先级）
   - `HIGH`：高优先级请求
   - `NORMAL`：普通请求
   - `QUERY`：查询请求（最低优先级）

3. **限流机制**
   - 时间窗口：`API_RATE_WINDOW`（默认2秒）
   - 请求限制：`API_RATE_LIMIT`（默认10次/窗口）
   - 最小间隔：`API_MIN_INTERVAL`（默认0.2秒）

4. **重试机制**
   - 最大重试次数：`API_MAX_RETRIES`（默认3次）
   - 指数退避策略
   - 超时控制：`API_REQUEST_TIMEOUT`（默认30秒）

**使用示例**：
```python
# 添加请求到队列
api_manager.add_request(
    func=exchange.fetch_ohlcv,
    args=('ETH/USDT:USDT', '15m'),
    priority=RequestPriority.NORMAL
)

# 获取结果（阻塞等待）
result = api_manager.get_result(request_id)
```

### 7.2 CoinGlass客户端 (`CoinGlassClient`)

**功能**：封装CoinGlass API调用，获取市场情绪、未平仓合约等数据

**支持的数据类型**：
- 未平仓合约历史 (`get_open_interest_history`)
- 多空比历史 (`get_long_short_ratio_history`)
- ETF资金流历史 (`get_etf_flow_history`)
- 恐惧贪婪指数历史 (`get_fear_greed_history`)

**特点**：
- 统一的错误处理
- 自动重试机制
- 数据格式验证

### 7.3 技术指标计算器 (`IndicatorCalculator`)

**功能**：计算各种技术指标，支持多时间周期

**支持的指标**：

| 指标 | 15分钟 | 4小时 | 日线 | 说明 |
|------|--------|-------|------|------|
| EMA | ✓ (9,21,55) | ✓ (9,21) | ✓ (9,21) | 指数移动平均线 |
| RSI | ✓ (7) | ✓ (14) | - | 相对强弱指标 |
| MACD | ✓ (8,17,9) | ✓ (12,26,9) | - | 指数平滑异同移动平均线 |
| 布林带 | ✓ (20,2) | ✓ (20,2) | - | 布林带（上轨、中轨、下轨） |
| ATR | ✓ (14) | - | - | 平均真实波幅 |
| OBV | ✓ | ✓ | - | 能量潮指标 |
| ADX | ✓ (14) | - | - | 平均趋向指标 |
| BB Width | ✓ | ✓ | - | 布林带宽度 |

**计算流程**：
```
原始K线数据
   │
   ├─→ 价格数据 (OHLCV)
   ├─→ 成交量数据
   │
   ▼
指标计算
   │
   ├─→ 趋势指标 (EMA, MACD)
   ├─→ 动量指标 (RSI, ADX)
   ├─→ 波动指标 (布林带, ATR, BB Width)
   └─→ 成交量指标 (OBV)
   │
   ▼
返回带指标的数据字典
```

### 7.4 数据库连接管理 (`Database`)

**功能**：管理PostgreSQL数据库连接，支持连接池和延迟初始化

**核心特性**：
- **连接池**：`pool_size=10`, `max_overflow=20`
- **连接健康检查**：`pool_pre_ping=True`
- **连接回收**：`pool_recycle=3600`（1小时）
- **延迟初始化**：避免循环依赖

**使用方式**：
```python
from app.database.connection import db

# 获取数据库会话
session = db.get_session()
try:
    # 执行数据库操作
    result = session.execute(text("SELECT * FROM klines_15m"))
finally:
    session.close()
```

### 7.5 配置管理器 (`ConfigManager`)

**功能**：从数据库读取配置，提供类型转换和缓存

**核心方法**：
- `get(key, default)`：获取配置值（自动类型转换）
- `get_string(key, default)`：获取字符串配置
- `get_int(key, default)`：获取整数配置
- `get_float(key, default)`：获取浮点数配置
- `get_bool(key, default)`：获取布尔配置
- `set(key, value, value_type, description)`：设置配置值
- `reload()`：重新加载配置

**配置缓存**：
- 启动时从数据库加载所有配置到内存
- 支持运行时更新配置
- 自动类型转换（string/int/float/boolean/json）

---

## 八、数据库设计概述

### 8.1 数据表分类

#### 时序数据表（TimescaleDB超表）
- `klines_15m`：15分钟K线数据
- `klines_4h`：4小时K线数据
- `klines_1d`：日线K线数据
- `funding_rate_history`：资金费率历史
- `open_interest_15m`：未平仓合约15分钟数据
- `market_sentiment_data`：市场情绪数据
- `order_book_distribution`：盘口挂单分布
- `etf_flow_data`：ETF资金流数据
- `fear_greed_index`：恐惧贪婪指数

#### 系统配置表
- `system_config`：系统配置项（所有配置存储在数据库中）

### 8.2 TimescaleDB优化

**超表配置**：
- **Chunk时间间隔**：根据数据更新频率设置（7天/30天/90天）
- **压缩策略**：30天后的数据自动压缩
- **保留策略**：根据数据重要性设置保留时间（90天/180天/365天/730天）

**优势**：
- 自动分区管理
- 数据压缩节省存储空间
- 自动数据清理
- 优化的时序查询性能

### 8.3 索引设计

**主键索引**：
- 所有表使用复合主键：`(symbol, time)` 或 `(symbol, date)`

**时间索引**：
- TimescaleDB自动为时间列创建索引

**查询优化**：
- 支持按币种和时间范围快速查询
- 支持聚合查询（SUM、AVG、MAX、MIN等）

---


