
# 其他数据源同步模块

## 一、模块概述

系统支持多个外部数据源的同步，包括资金费率、未平仓合约、市场情绪、盘口挂单、ETF资金流和恐惧贪婪指数。

## 二、数据源列表

### 2.1 资金费率同步（FundingRateSyncManager）

- **数据来源**：交易所API（OKX）
- **同步频率**：每8小时（00:00, 08:00, 16:00 UTC）
- **数据表**：`funding_rate_history`
- **字段**：funding_rate, open_interest
- **支持币种**：每个交易币种独立线程

### 2.2 未平仓合约同步（OpenInterestSyncManager）

- **数据来源**：CoinGlass API
- **同步频率**：每15分钟（00, 15, 30, 45分）
- **数据表**：`open_interest_15m`
- **字段**：oi_open, oi_high, oi_low, oi_close, oi_change, oi_change_pct
- **支持币种**：每个交易币种独立线程

### 2.3 市场情绪同步（MarketSentimentSyncManager）

- **数据来源**：CoinGlass API
- **同步频率**：每4小时
- **数据表**：`market_sentiment_data`
- **字段**：global_account_long_percent, global_account_short_percent, long_short_ratio
- **支持币种**：每个交易币种独立线程

### 2.4 盘口挂单同步（OrderBookSyncManager）

- **数据来源**：交易所API（OKX）
- **同步频率**：每1小时
- **数据表**：`order_book_distribution`
- **字段**：asks, bids, total_ask_amount, total_bid_amount, bid_ask_ratio
- **支持币种**：每个交易币种独立线程

### 2.5 ETF资金流同步（ETFFlowSyncManager）

- **数据来源**：CoinGlass API
- **同步频率**：每天8:00 UTC
- **数据表**：`etf_flow_data`
- **字段**：net_assets_usd, change_usd, price_usd
- **支持币种**：BTC, ETH（仅ETF相关币种）

### 2.6 恐惧贪婪指数同步（FearGreedSyncManager）

- **数据来源**：CoinGlass API
- **同步频率**：每天8:00 UTC
- **数据表**：`fear_greed_index`
- **字段**：value, classification, change
- **支持币种**：全局唯一（不区分币种）

## 三、同步机制

### 3.1 统一设计模式

所有同步管理器都继承 `threading.Thread`，独立后台线程运行：

```python
class XxxSyncManager(threading.Thread):
    def __init__(self, ...):
        # 初始化参数
    
    def run(self):
        # 主循环：定时检查并同步
    
    def stop(self):
        # 停止同步线程
    
    def _should_sync(self, now):
        # 判断是否应该同步
    
    def _fetch_and_save_xxx(self):
        # 获取并保存数据
```

### 3.2 同步频率控制

| 模块 | 同步频率 | 判断逻辑 |
|------|----------|----------|
| 资金费率 | 每8小时 | 00:00, 08:00, 16:00 UTC |
| 未平仓合约 | 每15分钟 | 00, 15, 30, 45分 |
| 市场情绪 | 每4小时 | 距离上次同步≥4小时 |
| 盘口挂单 | 每1小时 | 距离上次同步≥1小时 |
| ETF资金流 | 每天 | 8:00 UTC |
| 恐惧贪婪指数 | 每天 | 8:00 UTC |

## 四、数据来源

### 4.1 交易所API（OKX）

- **资金费率**：`api_manager.get_funding_rate()`
- **盘口挂单**：`exchange.fetch_order_book()`

### 4.2 CoinGlass API

- **未平仓合约**：`coinglass_client.get_open_interest_history()`
- **市场情绪**：`coinglass_client.get_long_short_ratio_history()`
- **ETF资金流**：`coinglass_client.get_etf_flow_history()`
- **恐惧贪婪指数**：`coinglass_client.get_fear_greed_history()`

## 五、使用示例

### 5.1 初始化

```python
from app.components.funding_rate_sync import FundingRateSyncManager
from app.components.open_interest_sync import OpenInterestSyncManager
from app.components.market_sentiment_sync import MarketSentimentSyncManager
from app.components.order_book_sync import OrderBookSyncManager
from app.components.etf_flow_sync import ETFFlowSyncManager
from app.components.fear_greed_sync import FearGreedSyncManager

# 资金费率同步
funding_rate_sync = FundingRateSyncManager(api_manager, "ETH")
funding_rate_sync.start()

# 未平仓合约同步
open_interest_sync = OpenInterestSyncManager(coinglass_client, "ETH")
open_interest_sync.start()

# 市场情绪同步
market_sentiment_sync = MarketSentimentSyncManager(coinglass_client, "ETH")
market_sentiment_sync.start()

# 盘口挂单同步
order_book_sync = OrderBookSyncManager(api_manager, "ETH")
order_book_sync.start()

# ETF资金流同步（仅BTC/ETH）
etf_flow_sync = ETFFlowSyncManager(coinglass_client, "ETH")
etf_flow_sync.start()

# 恐惧贪婪指数同步（全局唯一）
fear_greed_sync = FearGreedSyncManager(coinglass_client)
fear_greed_sync.start()
```

### 5.2 停止同步

```python
funding_rate_sync.stop()
funding_rate_sync.join(timeout=5)
```

## 六、配置参数

从 `system_config` 表读取：

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `FUNDING_RATE_START_DAYS` | 30 | 资金费率初始同步天数 |
| `COINGLASS_API_KEY` | - | CoinGlass API密钥 |

## 七、注意事项

1. **API限流**：CoinGlass API有请求频率限制，注意控制同步频率
2. **数据去重**：数据库主键约束防止重复数据
3. **错误处理**：API调用失败不影响其他数据源同步
4. **时区统一**：所有时间使用UTC时区
5. **多币种支持**：每个币种独立线程，互不影响
